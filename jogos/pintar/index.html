<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jogo de Pintura - MusiKids Fun</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Baloo+2&display=swap');
  html, body {
    margin: 0; padding: 0; height: 100%;
    background: linear-gradient(135deg, #f9ecd3 0%, #f4a261 100%);
    font-family: 'Baloo 2', cursive, Arial, sans-serif;
    user-select: none;
    overflow: hidden;
    display: flex; flex-direction: column;
  }
  header {
    font-size: 2rem; font-weight: 900; color: #d76f51;
    padding: 10px 0; text-align: center;
    background: #e9c46a; box-shadow: 0 3px 6px rgba(187,133,97,0.67);
    user-select: none;
  }
  #btn-back {
    position: fixed; top: 10px; left: 10px;
    background: #2a9d8f; color: white; font-weight: 700;
    padding: 10px 18px; border: none; border-radius: 20px;
    cursor: pointer; box-shadow: 0 6px 15px rgba(42,157,143,0.8);
    user-select: none; z-index: 1000;
    transition: background-color 0.3s ease;
  }
  #btn-back:hover { background: #21867a; }
  #top-bar {
    position: fixed; top: 10px; left: 60px; right: 20px;
    height: 56px; background: rgba(38,70,83,0.9);
    border-radius: 25px; padding: 8px 10px;
    display: flex; align-items: center; justify-content: center; gap: 12px;
    z-index: 900;
  }
  #top-bar button, #top-bar input[type=color] {
    height: 40px; border-radius: 12px; border: none;
    font-size: 18px; cursor: pointer; user-select: none;
    padding: 0 14px; background: #2a9d8f; color: #fff;
    box-shadow: 0 5px 15px #2a9d8fcc;
    transition: background-color 0.3s ease;
  }
  #top-bar button:hover, #top-bar input[type=color]:hover { background: #21867a; }
  #top-bar button:disabled { background: #777; cursor: not-allowed; }
  #toolbar {
    position: fixed; top: 76px; left: 10px; width: 56px;
    background: rgba(38,70,83,0.9); padding: 10px 5px;
    border-radius: 20px; display: flex; flex-direction: column;
    gap: 12px; z-index: 900;
  }
  .tool-btn {
    width: 44px; height: 44px; border-radius: 14px; border: none;
    background: #ffffffcc; color: #264653; font-size: 24px;
    display: flex; justify-content: center; align-items: center;
    cursor: pointer; user-select: none;
    box-shadow: 0 4px 9px rgba(0,0,0,0.2);
    transition: background-color 0.2s ease;
  }
  .tool-btn.selected { background: #2a9d8f; color: #fff; }
  .tool-btn:hover { background: #d8f3dc; }
  #color-picker { width: 44px; height: 44px; border-radius: 14px; border: none; margin-top: 6px; cursor: pointer; }
  #palette-container {
    position: fixed; top: 76px; right: 10px; width: 200px;
    height: calc(100vh - 76px); overflow-y: auto;
    background: #f7e8dfcc; border-radius: 18px; padding: 12px;
    box-shadow: 0 8px 30px #d98e5caa; user-select: none; z-index: 900;
  }
  #palette-container h3 {
    margin: 0 0 12px 0; font-weight: 700; font-size: 1.2rem;
    color: #d76f51; text-align: center;
  }
  .palette-item, .palette-shape {
    width: 90%; margin: 8px auto;
    cursor: grab; border-radius: 14px;
    box-shadow: 0 5px 10px #a85809cc;
    user-select: none; display: block;
  }
  .palette-shape {
    height: 80px; display: flex; justify-content: center; align-items: center;
  }
  .palette-shape.circle { background: #f94144; border-radius: 50%; }
  .palette-shape.square { background: #f3722c; }
  .palette-shape.triangle {
    width: 0; height: 0; background: none;
    border-left: 40px solid transparent; border-right: 40px solid transparent;
    border-bottom: 80px solid #f9844a;
    margin-left: auto; margin-right: auto;
  }
  #paint-area-container {
    margin-left: 80px; margin-top: 76px; flex-grow: 1;
    display: flex; justify-content: center; align-items: center;
    overflow: auto;
  }
  svg#paint-area {
    border-radius: 18px; border: 3px solid #264653;
    background: #fff9f0; max-width: 90vw; max-height: 82vh;
    display: block; user-select: none; touch-action: none;
  }
  path.outline {
    stroke: #264653; stroke-width: 3; fill: none;
    pointer-events: none;
  }
  path.fillable {
    fill: white; stroke: #264653; stroke-width: 2; cursor: pointer;
  }
</style>
</head>
<body>

<button id="btn-back" aria-label="Voltar ao menu" title="Voltar ao menu">‚Üê Menu</button>

<div id="top-bar" role="toolbar" aria-label="Controles do desenho">
  <button id="undo-btn" title="Desfazer" disabled>‚Ü©Ô∏è</button>
  <button id="redo-btn" title="Refazer" disabled>‚Ü™Ô∏è</button>
  <button id="clear-btn" title="Apagar tudo">üßπ</button>
  <input id="color-picker" type="color" value="#ff4a74" title="Selecionar cor" aria-label="Selecionar cor"/>
</div>

<div id="toolbar" role="toolbar" aria-label="Ferramentas">
  <button class="tool-btn selected" id="tool-pencil" aria-pressed="true" title="L√°pis">‚úèÔ∏è</button>
  <button class="tool-btn" id="tool-brush" aria-pressed="false" title="Pincel">üñåÔ∏è</button>
  <button class="tool-btn" id="tool-eraser" aria-pressed="false" title="Borracha">ü©π</button>
  <button class="tool-btn" id="tool-bucket" aria-pressed="false" title="Balde">ü™£</button>
</div>

<div id="palette-container" aria-label="Paleta de imagens e figuras">
  <h3>Imagens para pintar</h3>
  <img src="https://cdn.pixabay.com/photo/2016/10/18/21/06/dinosaur-1784536_1280.jpg" class="palette-item" draggable="true" alt="Dinossauro" />
  <img src="https://cdn.pixabay.com/photo/2014/04/10/10/02/owl-319913_1280.jpg" class="palette-item" draggable="true" alt="Coruja" />
  <img src="https://cdn.pixabay.com/photo/2016/01/22/15/36/dog-1151516_1280.jpg" class="palette-item" draggable="true" alt="Cachorro" />
  <img src="https://cdn.pixabay.com/photo/2016/03/27/19/17/turtle-1280223_1280.jpg" class="palette-item" draggable="true" alt="Tartaruga" />
  <img src="https://cdn.pixabay.com/photo/2017/06/20/23/21/girl-2421590_1280.jpg" class="palette-item" draggable="true" alt="Garota" />

  <h3>Formas geom√©tricas</h3>
  <div class="palette-shape circle" draggable="true" title="C√≠rculo" aria-label="Arraste para pintar c√≠rculo"></div>
  <div class="palette-shape square" draggable="true" title="Quadrado" aria-label="Arraste para pintar quadrado"></div>
  <div class="palette-shape triangle" draggable="true" title="Tri√¢ngulo" aria-label="Arraste para pintar tri√¢ngulo"></div>
</div>

<div id="paint-area-container">
  <svg id="paint-area" viewBox="0 0 600 400" role="img" aria-label="√Årea de pintura">
    <path class="outline" d="M100 120 Q 160 50, 220 120 T 340 120" />
    <path class="outline" d="M400 180 Q 460 130, 520 180 T 580 190" />
    <path class="fillable" d="M90 110 L350 110 L350 130 L90 130 Z" />
    <path class="fillable" d="M390 170 L590 170 L590 200 L390 200 Z" />
  </svg>
</div>

<script>
  const paintArea = document.getElementById('paint-area');
  const svgNS = "http://www.w3.org/2000/svg";

  const btnBack = document.getElementById('btn-back');
  const tools = {
    pencil: document.getElementById('tool-pencil'),
    brush: document.getElementById('tool-brush'),
    eraser: document.getElementById('tool-eraser'),
    bucket: document.getElementById('tool-bucket'),
  };
  const colorPicker = document.getElementById('color-picker');
  const undoBtn = document.getElementById('undo-btn');
  const redoBtn = document.getElementById('redo-btn');
  const clearBtn = document.getElementById('clear-btn');

  let currentTool = "pencil";
  let currentColor = colorPicker.value;
  let drawing = false;
  let currentPath = null;
  let pathData = "";

  // Undo redo stacks
  let undoStack = [];
  let redoStack = [];

  function updateUndoRedoButtons() {
    undoBtn.disabled = undoStack.length === 0;
    redoBtn.disabled = redoStack.length === 0;
  }

  // Tool selection
  function selectTool(name) {
    currentTool = name;
    Object.entries(tools).forEach(([k, btn]) => {
      btn.classList.toggle("selected", k === name);
      btn.setAttribute("aria-pressed", k === name ? "true" : "false");
    });
    redoStack = [];
    updateUndoRedoButtons();
  }
  Object.entries(tools).forEach(([k, btn]) =>
    btn.addEventListener("click", () => selectTool(k))
  );
  selectTool("pencil");

  colorPicker.oninput = (e) => {
    currentColor = e.target.value;
  };

  // Undo/Redo functions
  function pushUndo(action) {
    undoStack.push(action);
    if (undoStack.length > 50) undoStack.shift();
    redoStack = [];
    updateUndoRedoButtons();
  }
  undoBtn.addEventListener("click", () => {
    if (undoStack.length === 0) return;
    const action = undoStack.pop();
    if (["draw", "erase", "image"].includes(action.type)) {
      paintArea.removeChild(action.element);
      redoStack.push(action);
    } else if (action.type === "fill") {
      action.element.setAttribute("fill", action.oldColor);
      action.element.setAttribute("data-filled", action.oldFilled);
      redoStack.push(action);
    } else if (action.type === "clear") {
      action.elements.forEach((el) => paintArea.appendChild(el));
      redoStack.push(action);
    }
    updateUndoRedoButtons();
  });
  redoBtn.addEventListener("click", () => {
    if (redoStack.length === 0) return;
    const action = redoStack.pop();
    if (["draw", "erase", "image"].includes(action.type)) {
      paintArea.appendChild(action.element);
      undoStack.push(action);
    } else if (action.type === "fill") {
      action.element.setAttribute("fill", action.newColor);
      action.element.setAttribute("data-filled", "true");
      undoStack.push(action);
    } else if (action.type === "clear") {
      action.elements.forEach((el) => paintArea.removeChild(el));
      undoStack.push(action);
    }
    updateUndoRedoButtons();
  });

  clearBtn.addEventListener("click", () => {
    const allDrawn = [...paintArea.querySelectorAll("path, image")].filter(
      (el) => !el.classList.contains("outline") && !el.classList.contains("fillable")
    );
    if (allDrawn.length === 0) return;
    allDrawn.forEach((el) => paintArea.removeChild(el));
    pushUndo({ type: "clear", elements: allDrawn });
  });

  // Drawing logic
  paintArea.addEventListener("mousedown", (e) => {
    if (currentTool === "bucket") return;
    if (e.target.classList.contains("palette-item") || e.target.tagName === "image")
      return;
    drawing = true;
    const pt = getSVGPoint(e);
    pathData = `M ${pt.x} ${pt.y}`;
    currentPath = document.createElementNS(svgNS, "path");
    currentPath.setAttribute("fill", "none");
    currentPath.setAttribute(
      "stroke",
      currentTool === "eraser" ? "#fff" : currentColor
    );
    currentPath.setAttribute(
      "stroke-width",
      currentTool === "brush" ? "8" : currentTool === "eraser" ? "12" : "2"
    );
    currentPath.setAttribute("stroke-linejoin", "round");
    currentPath.setAttribute("stroke-linecap", "round");
    currentPath.setAttribute("d", pathData);
    paintArea.appendChild(currentPath);
    pushUndo({ type: currentTool === "eraser" ? "erase" : "draw", element: currentPath });
  });

  paintArea.addEventListener("mousemove", (e) => {
    if (!drawing || !currentPath) return;
    const pt = getSVGPoint(e);
    pathData += ` L ${pt.x} ${pt.y}`;
    currentPath.setAttribute("d", pathData);
  });

  function stopDrawing() {
    drawing = false;
    currentPath = null;
  }

  paintArea.addEventListener("mouseup", stopDrawing);
  paintArea.addEventListener("mouseleave", stopDrawing);

  // Bucket fill functionality
  paintArea.querySelectorAll("path.fillable").forEach((path) => {
    path.addEventListener("click", (e) => {
      if (currentTool !== "bucket") return;
      const el = e.target;
      const oldColor = el.getAttribute("fill") || "white";
      const oldFilled = el.getAttribute("data-filled") || "false";
      if (oldColor.toLowerCase() === currentColor.toLowerCase() && oldFilled === "true")
        return;
      el.setAttribute("fill", currentColor);
      el.setAttribute("data-filled", "true");
      pushUndo({ type: "fill", element: el, oldColor: oldColor, newColor: currentColor, oldFilled: oldFilled });
    });
  });

  // Drag and drop setup
  const paletteItems = document.querySelectorAll(".palette-item, .palette-shape");
  paletteItems.forEach((item) => {
    item.addEventListener("dragstart", (e) => {
      if (item.classList.contains("palette-item")) {
        e.dataTransfer.setData("text/plain", item.src);
      } else {
        e.dataTransfer.setData("text/plain", item.className.baseVal || item.className);
      }
    });
  });

  paintArea.addEventListener("dragover", (e) => e.preventDefault());
  paintArea.addEventListener("drop", (e) => {
    e.preventDefault();
    const data = e.dataTransfer.getData("text/plain");
    if (!data) return;
    const pt = getSVGPoint(e);

    if (data.startsWith("http") || data.match(/\.(png|jpg|jpeg|gif|svg)$/i)) {
      const newImg = document.createElementNS(svgNS, "image");
      newImg.setAttributeNS("http://www.w3.org/1999/xlink", "href", data);
      newImg.setAttribute("x", pt.x - 50);
      newImg.setAttribute("y", pt.y - 50);
      newImg.setAttribute("width", 100);
      newImg.setAttribute("height", 100);
      newImg.style.cursor = "grab";
      paintArea.appendChild(newImg);
      pushUndo({ type: "image", element: newImg });
      makeDraggable(newImg);
    } else {
      let shapeEl;
      if (data.includes("circle")) {
        shapeEl = document.createElementNS(svgNS, "circle");
        shapeEl.setAttribute("cx", pt.x);
        shapeEl.setAttribute("cy", pt.y);
        shapeEl.setAttribute("r", 50);
        shapeEl.setAttribute("fill", currentColor);
        shapeEl.setAttribute("stroke", "#264653");
        shapeEl.setAttribute("stroke-width", 3);
      } else if (data.includes("square")) {
        shapeEl = document.createElementNS(svgNS, "rect");
        shapeEl.setAttribute("x", pt.x - 50);
        shapeEl.setAttribute("y", pt.y - 50);
        shapeEl.setAttribute("width", 100);
        shapeEl.setAttribute("height", 100);
        shapeEl.setAttribute("fill", currentColor);
        shapeEl.setAttribute("stroke", "#264653");
        shapeEl.setAttribute("stroke-width", 3);
        shapeEl.setAttribute("rx", 10);
        shapeEl.setAttribute("ry", 10);
      } else if (data.includes("triangle")) {
        shapeEl = document.createElementNS(svgNS, "polygon");
        const points = [
          [pt.x, pt.y - 58],
          [pt.x - 50, pt.y + 42],
          [pt.x + 50, pt.y + 42],
        ];
        shapeEl.setAttribute(
          "points",
          points.map((p) => p.join(",")).join(" ")
        );
        shapeEl.setAttribute("fill", currentColor);
        shapeEl.setAttribute("stroke", "#264653");
        shapeEl.setAttribute("stroke-width", 3);
      }
      if (shapeEl) {
        shapeEl.style.cursor = "grab";
        paintArea.appendChild(shapeEl);
        pushUndo({ type: "image", element: shapeEl });
        makeDraggable(shapeEl);
      }
    }
  });

  function makeDraggable(el) {
    let dragging = false;
    let offsetX, offsetY;

    el.addEventListener("mousedown", (e) => {
      e.preventDefault();
      dragging = true;
      const pt = getSVGPoint(e);
      if (el.tagName === "circle") {
        offsetX = pt.x - parseFloat(el.getAttribute("cx"));
        offsetY = pt.y - parseFloat(el.getAttribute("cy"));
      } else {
        offsetX = pt.x - parseFloat(el.getAttribute("x"));
        offsetY = pt.y - parseFloat(el.getAttribute("y"));
      }
      el.style.cursor = "grabbing";
    });

    paintArea.addEventListener("mousemove", (e) => {
      if (!dragging) return;
      const pt = getSVGPoint(e);
      if (el.tagName === "circle") {
        el.setAttribute("cx", pt.x - offsetX);
        el.setAttribute("cy", pt.y - offsetY);
      } else {
        el.setAttribute("x", pt.x - offsetX);
        el.setAttribute("y", pt.y - offsetY);
      }
    });

    paintArea.addEventListener("mouseup", (e) => {
      if (dragging) {
        dragging = false;
        el.style.cursor = "grab";
      }
    });
    paintArea.addEventListener("mouseleave", (e) => {
      if (dragging) {
        dragging = false;
        el.style.cursor = "grab";
      }
    });
  }

  function getSVGPoint(event) {
    const pt = paintArea.createSVGPoint();
    pt.x = event.clientX;
    pt.y = event.clientY;
    return pt.matrixTransform(paintArea.getScreenCTM().inverse());
  }
</script>
</body>
</html>
