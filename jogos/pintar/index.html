<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jogo de Pintura - MusiKids</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Baloo&display=swap');
  html, body {
    margin: 0; padding: 0; height: 100%;
    background: linear-gradient(135deg, #f9ecd3 0%, #f4a261 100%);
    font-family: 'Baloo', cursive, Arial, sans-serif;
    user-select: none;
    overflow: hidden;
    display: flex; flex-direction: column;
  }
  header {
    font-size: 2rem;
    font-weight: 900;
    text-align: center;
    padding: 10px 0;
    background: #e2a343;
    color: #5B4215;
    user-select: none;
  }
  /* Bot√£o voltar */
  #btn-back {
    position: fixed;
    top: 12px;
    left: 12px;
    background: #3b7998;
    color: white;
    border: none;
    border-radius: 20px;
    padding: 10px 20px;
    font-weight: 700;
    cursor: pointer;
    z-index: 1000;
    box-shadow: 0 5px 15px rgba(59,121,152,0.7);
    user-select: none;
    transition: background-color 0.3s ease;
  }
  #btn-back:hover {
    background: #2e5e69;
  }
  /* Bot√µes flutuantes */
  #button-controls {
    position: fixed;
    top: 12px;
    right: 12px;
    z-index: 1000;
    display: flex;
    gap: 10px;
  }
  #button-controls button {
    background: #3b7998;
    border: none;
    color: white;
    border-radius: 20px;
    padding: 10px 16px;
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(59,121,152,0.7);
    user-select: none;
    transition: background-color 0.3s ease;
  }
  #button-controls button:disabled {
    background: #7499ad;
    cursor: not-allowed;
  }
  #button-controls button:hover:not(:disabled) {
    background: #2e5e69;
  }
  /* Paletas externas */
  #tools-panel {
    position: fixed;
    top: 60px;
    left: 12px;
    background: rgba(59,121,152,0.9);
    border-radius: 20px;
    padding: 10px 6px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    z-index: 999;
  }
  .tool-button {
    width: 48px;
    height: 48px;
    background: #def2f4;
    border-radius: 20px;
    border: none;
    font-size: 24px;
    color: #214f59;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    user-select: none;
    transition: background-color 0.25s ease;
  }
  .tool-button.selected {
    background: #1a4046;
    color: white;
  }
  .tool-button:hover {
    background: #a6d4e7;
    color: #1a4046;
  }
  #color-picker {
    margin-top: 10px;
    width: 48px;
    height: 48px;
    border-radius: 24px;
    border: none;
    cursor: pointer;
  }
  #palette-container {
    position: fixed;
    top: 60px;
    right: 12px;
    width: 210px;
    max-height: 70vh;
    background: #f7f0dfcc;
    box-shadow: 0 5px 18px rgba(168, 84, 14, 0.7);
    border-radius: 20px;
    padding: 10px;
    overflow-y: auto;
    z-index: 998;
  }
  #palette-container h3 {
    font-weight: 700;
    text-align: center;
    margin: 0 0 10px 0;
    color: #a65100;
    user-select: none;
  }
  .palette-item, .palette-shape {
    width: 90%;
    margin: 6px auto;
    border: 2px solid black;
    background: white;
    border-radius: 12px;
    box-shadow: 0 5px 14px rgba(165,81,7,0.7);
    cursor: grab;
    user-select: none;
    display: block;
  }
  .palette-shape {
    height: 75px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .palette-shape.circle {
    border-radius: 50%;
  }
  .palette-shape.triangle {
    width: 0;
    height: 0;
    border-left: 30px solid transparent;
    border-right: 30px solid transparent;
    border-bottom: 50px solid black;
    margin: 12px auto;
  }
  /* √Årea de pintura */
  #paint-area-container {
    margin-left: 75px;
    margin-top: 60px;
    flex-grow: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: auto;
  }
  svg#paint-area {
    border-radius: 20px;
    border: 4px solid #214f59;
    background: white;
    max-width: 90vw;
    max-height: 80vh;
    display: block;
    user-select: none;
  }
  path.outline {
    fill: none;
    stroke: black;
    stroke-width: 3;
    pointer-events: none;
  }
  path.fillable {
    fill: white;
    stroke: black;
    stroke-width: 2;
    cursor: pointer;
  }
</style>
</head>
<body>
  <button id="btn-back" aria-label="bot√£o de voltar ao menu de jogos">MENU DE JOGOS</button>
  <div id="button-controls" role="toolbar" aria-label="Controle do desenho">
    <button id="undo-btn" aria-label="Desfazer a√ß√£o" disabled>‚Ü©Ô∏è</button>
    <button id="redo-btn" aria-label="Refazer a√ß√£o" disabled>‚Ü™Ô∏è</button>
  </div>
  <div id="tools-panel" role="toolbar" aria-label="painel de ferramentas">
    <button id="tool-pencil" class="tool-button selected" aria-label="L√°pis de desenho" title="L√°pis">‚úèÔ∏è</button>
    <button id="tool-eraser" class="tool-button" aria-label="Borracha" title="Borracha">ü©π</button>
    <button id="tool-brush" class="tool-button" aria-label="Pincel" title="Pincel">üñåÔ∏è</button>
    <button id="tool-bucket" class="tool-button" aria-label="Balde de tinta" title="Balde de tinta">ü™£</button>
    <input id="color-picker" type="color" aria-label="Seletor de cor" value="#000000" title="Selecione cor"/>
    <div id="scale-controls" style="display: flex; margin-top: 5px; gap: 8px;">
      <button id="scale-increase" aria-label="Aumentar tamanho" title="Aumentar tamanho" style="width: 36px; height: 36px; border-radius: 8px;">Ôºã</button>
      <button id="scale-decrease" aria-label="Diminuir tamanho" title="Diminuir tamanho" style="width: 36px; height: 36px; border-radius: 8px;">Ôºç</button>
    </div>
  </div>
  <div id="palette-container" aria-label="Paleta de imagens">
    <h3>Imagens para pintar</h3>
    <img src="https://cdn.pixabay.com/photo/2016/10/18/21/06/dinosaur-1784536_1280.jpg" class="palette-item" alt="Dinossauro" draggable="true"/>
    <img src="https://cdn.pixabay.com/photo/2014/04/10/10/02/owl-319913_1280.jpg" class="palette-item" alt="Coruja" draggable="true"/>
    <img src="https://cdn.pixabay.com/photo/2016/01/22/15/36/dog-1151516_1280.jpg" class="palette-item" alt="Cachorro" draggable="true"/>
    <img src="https://cdn.pixabay.com/photo/2016/03/27/19/17/turtle-1280223_1280.jpg" class="palette-item" alt="Tartaruga" draggable="true"/>
    <img src="https://cdn.pixabay.com/photo/2017/06/20/09/23/girl-2421493_1280.jpg" class="palette-item" alt="Garota" draggable="true"/>
    <h3>Formas geom√©tricas</h3>
    <div id="circle" class="palette-shape circle" draggable="true" tabindex="0" aria-label="C√≠rculo"></div>
    <div id="square" class="palette-shape" draggable="true" tabindex="0" aria-label="Quadrado"></div>
    <div id="triangle" class="palette-shape triangle" draggable="true" tabindex="0" aria-label="Tri√¢ngulo"></div>
  </div>
  <div id="paint-area-container">
    <svg id="paint-area" viewBox="0 0 600 400" role="img" aria-label="√Årea para pintura" tabindex="0">
      <path class="outline" d="M100 120 Q 160 50, 220 120 T 340 120" />
      <path class="outline" d="M400 180 Q 460 130, 520 180 T 580 190" />
      <path class="fillable" d="M90 110 L 350 110 L 350 130 L 90 130 Z" />
      <path class="fillable" d="M390 170 L 590 170 L 590 200 L 390 200 Z" />
    </svg>
  </div>
  <script>
    const paintArea = document.getElementById("paint-area");
    const svgNS = "http://www.w3.org/2000/svg";

    const btnBack = document.getElementById("btn-back");
    const tools = {
      pencil: document.getElementById("tool-pencil"),
      eraser: document.getElementById("tool-eraser"),
      brush: document.getElementById("tool-brush"),
      bucket: document.getElementById("tool-bucket"),
    };

    const scaleIncrease = document.getElementById("scale-increase");
    const scaleDecrease = document.getElementById("scale-decrease");

    const colorPicker = document.getElementById("color-picker");
    const undoBtn = document.getElementById("undo-btn");
    const redoBtn = document.getElementById("redo-btn");
    const clearBtn = document.getElementById("scale-decrease"); // Will add clear button logic to scale buttons

    let currentTool = "pencil";
    let currentColor = colorPicker.value;

    let isDrawing = false;
    let currentPath = null;
    let pathData = "";

    let selectedElement = null;
    let scale = 1;

    // Undo/Redo stacks
    let undoStack = [];
    let redoStack = [];

    function updateUndoRedoButtons() {
      undoBtn.disabled = undoStack.length === 0;
      redoBtn.disabled = redoStack.length === 0;
    }

    function pushUndo(action) {
      undoStack.push(action);
      if (undoStack.length > 50) undoStack.shift();
      redoStack = [];
      updateUndoRedoButtons();
    }

    undoBtn.onclick = function () {
      if (undoStack.length === 0) return;
      const action = undoStack.pop();
      if (["draw", "erase", "image", "shape"].includes(action.type)) {
        paintArea.removeChild(action.element);
        if (selectedElement === action.element) selectedElement = null;
        redoStack.push(action);
      } else if (action.type === "fill") {
        action.element.setAttribute("fill", action.oldColor);
        action.element.setAttribute("data-filled", action.oldFilled);
        redoStack.push(action);
      } else if (action.type === "clear") {
        action.elements.forEach((el) => paintArea.appendChild(el));
        redoStack.push(action);
      }
      updateUndoRedoButtons();
    };

    redoBtn.onclick = function () {
      if (redoStack.length === 0) return;
      const action = redoStack.pop();
      if (["draw", "erase", "image", "shape"].includes(action.type)) {
        paintArea.appendChild(action.element);
        redoStack.push(action);
        selectedElement = action.element;
      } else if (action.type === "fill") {
        action.element.setAttribute("fill", action.newColor);
        action.element.setAttribute("data-filled", "true");
        redoStack.push(action);
      } else if (action.type === "clear") {
        action.elements.forEach((el) => paintArea.removeChild(el));
        redoStack.push(action);
      }
      updateUndoRedoButtons();
    };

    // Clear all painted paths
    document.getElementById("scale-increase").onclick = function () {
      if (!selectedElement) return;
      scale = Math.min(scale + 0.1, 3);
      if (selectedElement.tagName === "circle") {
        const r = parseFloat(selectedElement.getAttribute("r"));
        selectedElement.setAttribute("r", r * (1 + 0.1));
      } else if (selectedElement.tagName === "rect") {
        const w = parseFloat(selectedElement.getAttribute("width"));
        const h = parseFloat(selectedElement.getAttribute("height"));
        selectedElement.setAttribute("width", w * (1 + 0.1));
        selectedElement.setAttribute("height", h * (1 + 0.1));
      } else if (selectedElement.tagName === "polygon") {
        // Scale polygon points
        let points = selectedElement.getAttribute("points").trim().split(" ");
        let centerX = 0;
        let centerY = 0;
        points.forEach((p) => {
          let [x, y] = p.split(",");
          centerX += parseFloat(x);
          centerY += parseFloat(y);
        });
        centerX /= points.length;
        centerY /= points.length;
        points = points.map((p) => {
          let [x, y] = p.split(",");
          let dx = parseFloat(x) - centerX;
          let dy = parseFloat(y) - centerY;
          return `${centerX + dx * 1.1},${centerY + dy * 1.1}`;
        });
        selectedElement.setAttribute("points", points.join(" "));
      }
    };

    document.getElementById("scale-decrease").onclick = function () {
      if (!selectedElement) return;
      scale = Math.max(scale - 0.1, 0.1);
      if (selectedElement.tagName === "circle") {
        const r = parseFloat(selectedElement.getAttribute("r"));
        selectedElement.setAttribute("r", r * 0.9);
      } else if (selectedElement.tagName === "rect") {
        const w = parseFloat(selectedElement.getAttribute("width"));
        const h = parseFloat(selectedElement.getAttribute("height"));
        selectedElement.setAttribute("width", w * 0.9);
        selectedElement.setAttribute("height", h * 0.9);
      } else if (selectedElement.tagName === "polygon") {
        // Scale polygon points
        let points = selectedElement.getAttribute("points").trim().split(" ");
        let centerX = 0;
        let centerY = 0;
        points.forEach((p) => {
          let [x, y] = p.split(",");
          centerX += parseFloat(x);
          centerY += parseFloat(y);
        });
        centerX /= points.length;
        centerY /= points.length;
        points = points.map((p) => {
          let [x, y] = p.split(",");
          let dx = parseFloat(x) - centerX;
          let dy = parseFloat(y) - centerY;
          return `${centerX + dx * 0.9},${centerY + dy * 0.9}`;
        });
        selectedElement.setAttribute("points", points.join(" "));
      }
    };

    // Drawing tool logic
    paintArea.addEventListener("mousedown", (e) => {
      if (currentTool === "bucket") return;
      if (
        e.target.classList.contains("palette-item") ||
        e.target.classList.contains("palette-shape") ||
        e.target.tagName === "image"
      )
        return;

      if (selectedElement) {
        selectedElement = null;
      }

      if (!e.target.isSameNode(paintArea)) {
        // Clicked on an element, not empty area
        return;
      }

      isDrawing = true;
      let pt = getSVGPoint(e);
      pathData = `M ${pt.x} ${pt.y}`;
      currentPath = document.createElementNS(svgNS, "path");

      currentPath.setAttribute("fill", "none");
      currentPath.setAttribute(
        "stroke",
        currentTool === "eraser" ? "#fff" : colorPicker.value
      );
      currentPath.setAttribute(
        "stroke-width",
        currentTool === "brush"
          ? 8
          : currentTool === "eraser"
          ? 12
          : 2
      );
      currentPath.setAttribute("stroke-linejoin", "round");
      currentPath.setAttribute("stroke-linecap", "round");
      currentPath.setAttribute("d", pathData);
      currentPath.style.cursor = "default";

      paintArea.appendChild(currentPath);
      pushUndo({ type: currentTool === "eraser" ? "erase" : "draw", element: currentPath });
    });

    paintArea.addEventListener("mousemove", (e) => {
      if (!isDrawing || !currentPath) return;
      let pt = getSVGPoint(e);
      pathData += ` L ${pt.x} ${pt.y}`;
      currentPath.setAttribute("d", pathData);
    });

    function stopDrawing() {
      isDrawing = false;
      currentPath = null;
    }
    paintArea.addEventListener("mouseup", stopDrawing);
    paintArea.addEventListener("mouseleave", stopDrawing);

    // Bucket fill
    paintArea.querySelectorAll("path.fillable").forEach((path) => {
      path.addEventListener("click", (e) => {
        if (currentTool !== "bucket") return;

        let el = e.target;
        let prevFill = el.getAttribute("fill") || "white";
        let prevFilled = el.getAttribute("data-filled") || "false";

        if (prevFill.toLowerCase() === colorPicker.value.toLowerCase() && prevFilled === "true")
          return;

        el.setAttribute("fill", colorPicker.value);
        el.setAttribute("data-filled", "true");
        pushUndo({
          type: "fill",
          element: el,
          oldColor: prevFill,
          newColor: colorPicker.value,
          oldFilled: prevFilled,
        });
      });
    });

    // Drag & drop from palette
    const paletteItems = document.querySelectorAll(".palette-item, .palette-shape");
    paletteItems.forEach(item =>
      item.addEventListener("dragstart", e => {
        e.dataTransfer.setData(
          "application/json",
          JSON.stringify({
            type: item.classList.contains("palette-item") ? "image" : "shape",
            src: item.src || null,
            shape: [...item.classList].find(c => ["circle", "square", "triangle"].includes(c)) || null,
          })
        );
        item.classList.add("dragging");
      })
    );

    paletteItems.forEach(item => item.addEventListener("dragend", e => {
      e.target.classList.remove("dragging");
    }));

    paintArea.addEventListener("dragover", e => e.preventDefault());

    paintArea.addEventListener("drop", e => {
      e.preventDefault();
      let data = e.dataTransfer.getData("application/json");
      if (!data) return;
      data = JSON.parse(data);

      let pt = getSVGPoint(e);

      if (data.type === "image" && data.src) {
        let img = document.createElementNS(svgNS, "image");
        img.setAttributeNS("http://www.w3.org/1999/xlink", "href", data.src);
        img.setAttribute("x", pt.x - 50);
        img.setAttribute("y", pt.y - 50);
        img.setAttribute("width", 100);
        img.setAttribute("height", 100);
        img.style.cursor = "grab";

        paintArea.appendChild(img);
        pushUndo({ type: "image", element: img });
        makeDraggable(img);
      } else if (data.type === "shape" && data.shape) {
        let el;
        if (data.shape === "circle") {
          el = document.createElementNS(svgNS, "circle");
          el.setAttribute("cx", pt.x);
          el.setAttribute("cy", pt.y);
          el.setAttribute("r", 50);
          el.setAttribute("fill", "none");
          el.setAttribute("stroke", "black");
          el.setAttribute("stroke-width", 3);
        } else if (data.shape === "square") {
          el = document.createElementNS(svgNS, "rect");
          el.setAttribute("x", pt.x - 50);
          el.setAttribute("y", pt.y - 50);
          el.setAttribute("width", 100);
          el.setAttribute("height", 100);
          el.setAttribute("fill", "none");
          el.setAttribute("stroke", "black");
          el.setAttribute("stroke-width", 3);
          el.setAttribute("rx", 15);
          el.setAttribute("ry", 15);
        } else if (data.shape === "triangle") {
          el = document.createElementNS(svgNS, "polygon");
          el.setAttribute(
            "points",
            `${pt.x},${pt.y - 58} ${pt.x - 50},${pt.y + 42} ${pt.x + 50},${pt.y + 42}`
          );
          el.setAttribute("fill", "none");
          el.setAttribute("stroke", "black");
          el.setAttribute("stroke-width", 3);
        }
        if (el) {
          el.style.cursor = "grab";
          paintArea.appendChild(el);
          pushUndo({ type: "image", element: el });
          makeDraggable(el);
        }
      }
    });

    function makeDraggable(el) {
      let dragging = false;
      let offsetX = 0;
      let offsetY = 0;

      function getEventPoint(evt) {
        let pt = paintArea.createSVGPoint();
        pt.x = evt.clientX;
        pt.y = evt.clientY;
        return pt.matrixTransform(paintArea.getScreenCTM().inverse());
      }

      el.addEventListener("mousedown", (e) => {
        e.preventDefault();
        isDrawing = false;
        dragging = true;
        let pt = getEventPoint(e);
        if (el.tagName === "circle") {
          offsetX = pt.x - parseFloat(el.getAttribute("cx"));
          offsetY = pt.y - parseFloat(el.getAttribute("cy"));
        } else {
          offsetX = pt.x - parseFloat(el.getAttribute("x"));
          offsetY = pt.y - parseFloat(el.getAttribute("y"));
        }
        el.style.cursor = "grabbing";
      });

      paintArea.addEventListener("mousemove", (e) => {
        if (!dragging) return;
        e.preventDefault();
        let pt = getEventPoint(e);
        if (el.tagName === "circle") {
          el.setAttribute("cx", pt.x - offsetX);
          el.setAttribute("cy", pt.y - offsetY);
        } else {
          el.setAttribute("x", pt.x - offsetX);
          el.setAttribute("y", pt.y - offsetY);
        }
      });

      paintArea.addEventListener("mouseup", () => {
        dragging = false;
        el.style.cursor = "grab";
      });

      paintArea.addEventListener("mouseleave", () => {
        dragging = false;
        el.style.cursor = "grab";
      });
    }
  </script>
</body>
</html>
