<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jogo de Pintar - MusiKids Fun</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Baloo+2&display=swap');
  body, html {
    margin: 0; padding: 0; height: 100%;
    background: linear-gradient(135deg, #f9ecd3 0%, #f4a261 100%);
    font-family: 'Baloo 2', cursive, Arial, sans-serif;
    user-select: none;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  header {
    font-size: 2rem;
    color: #d76f51;
    font-weight: 900;
    text-align: center;
    padding: 0.8rem 0;
    background: #e9c46a;
    box-shadow: 0 3px 6px #bb8561aa;
    user-select: none;
    margin-bottom: 4px;
  }
  #btn-back {
    position: fixed;
    top: 15px;
    left: 15px;
    background: #2a9d8f;
    color: white;
    padding: 12px 20px;
    font-weight: 700;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    box-shadow: 0 6px 15px #2a9d8fcc;
    transition: background-color 0.3s ease;
    z-index: 1000;
  }
  #btn-back:hover {
    background: #21867a;
  }
  #toolbar {
    position: fixed;
    top: 60px;
    left: 15px;
    background: #264653cc;
    padding: 12px;
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 900;
  }
  .tool-btn {
    width: 44px;
    height: 44px;
    border-radius: 14px;
    border: none;
    background: #ffffffdd;
    cursor: pointer;
    box-shadow: 0 4px 9px #00000033;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: #264653;
    transition: background-color 0.25s;
  }
  .tool-btn.selected {
    background: #2a9d8f;
    color: white;
  }
  .tool-btn:hover {
    background: #d8f3dc;
  }
  #color-palette {
    display: flex;
    flex-wrap: wrap;
    width: 220px;
    gap: 8px;
    margin-top: 10px;
    justify-content: center;
  }
  .color-dot {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    box-shadow: 0 1px 3px #00000055;
    transition: border-color 0.2s;
  }
  .color-dot.selected {
    border-color: #2a9d8f;
    box-shadow: 0 0 8px #2a9d8f;
  }
  #image-palette {
    position: fixed;
    top: 60px;
    right: 15px;
    width: 200px;
    background: #f7e8dfcc;
    border-radius: 18px;
    padding: 8px;
    box-shadow: 0 8px 30px #d98e5caa;
    overflow-y: auto;
    max-height: 75vh;
    user-select: none;
    z-index: 900;
  }
  #image-palette h3 {
    margin: 0 0 8px 0;
    color: #d76f51;
    font-weight: 700;
    font-size: 1.2rem;
    text-align: center;
  }
  .palette-image {
    width: 90%;
    margin: 6px auto;
    border: 3px solid transparent;
    border-radius: 14px;
    cursor: grab;
    transition: border-color 0.2s;
    display: block;
  }
  .palette-image.dragging {
    opacity: 0.6;
    cursor: grabbing;
  }
  .palette-image:hover {
    border-color: #d76f51;
  }
  #geom-palette {
    position: fixed;
    top: 260px;
    right: 15px;
    width: 190px;
    background: #ffd6a5cc;
    border-radius: 18px;
    padding: 8px;
    box-shadow: 0 8px 30px #d98e5caa;
    overflow-y: auto;
    max-height: 55vh;
    user-select: none;
    z-index: 900;
  }
  #geom-palette h3 {
    margin: 0 0 8px 0;
    color: #d35400;
    font-weight: 700;
    font-size: 1.2rem;
    text-align: center;
  }
  .geom-shape {
    width: 80px;
    height: 80px;
    margin: 8px auto;
    border-radius: 12px;
    background-color: #ff7f50;
    cursor: grab;
    transition: box-shadow 0.2s;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .geom-shape.circle {
    border-radius: 50%;
    background-color: #f94144;
  }
  .geom-shape.square {
    background-color: #f3722c;
  }
  .geom-shape.triangle {
    width: 0; height: 0;
    border-left: 40px solid transparent;
    border-right: 40px solid transparent;
    border-bottom: 80px solid #f9844a;
    background: none;
  }
  .geom-shape.dragging {
    opacity: 0.6;
    cursor: grabbing;
  }
  #canvas-container {
    margin-left: 90px;
    margin-top: 60px;
    height: calc(100vh - 60px);
    overflow: auto;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  svg#paint-area {
    border: 3px solid #264653;
    border-radius: 20px;
    background: #fff9f0;
    max-width: 90vw;
    max-height: 85vh;
    display: block;
    user-select: none;
    touch-action: none;
  }
  path.outline {
    stroke: #264653;
    stroke-width: 3;
    fill: none;
    pointer-events: none;
  }
  path.fillable {
    fill: white;
    stroke: #264653;
    stroke-width: 2;
    cursor: pointer;
  }
  #undo-redo {
    position: fixed;
    bottom: 20px;
    left: 20px;
    display: flex;
    gap: 12px;
    z-index: 1001;
  }
  .undo-redo-btn {
    padding: 12px 20px;
    border-radius: 16px;
    border: none;
    font-weight: 700;
    background-color: #2a9d8f;
    color: white;
    cursor: pointer;
    box-shadow: 0 6px 15px #2a9d8fcc;
    transition: background-color 0.3s ease;
  }
  .undo-redo-btn:disabled {
    background-color: #999999aa;
    cursor: not-allowed;
  }
  .undo-redo-btn:hover:not(:disabled) {
    background-color: #21867a;
  }
</style>
</head>
<body>

<button id="btn-back" aria-label="Voltar ao menu de jogos" title="Voltar ao menu">‚Üê Menu</button>

<div id="toolbar" role="toolbar" aria-label="Ferramentas de Pintura">
  <button class="tool-btn selected" id="tool-pencil" title="L√°pis - pintura livre" aria-pressed="true" aria-label="Selecionar L√°pis">‚úèÔ∏è</button>
  <button class="tool-btn" id="tool-brush" title="Pincel - tra√ßo grosso" aria-pressed="false" aria-label="Selecionar Pincel">üñåÔ∏è</button>
  <button class="tool-btn" id="tool-eraser" title="Borracha - apagar pintura" aria-pressed="false" aria-label="Selecionar Borracha">ü©π</button>
  <button class="tool-btn" id="tool-bucket" title="Balde de tinta - preencher" aria-pressed="false" aria-label="Selecionar Balde de Tinta">ü™£</button>
  <input type="color" id="color-picker" title="Escolha a cor da tinta" value="#ff4c8b" 
         style="margin-top:10px; border-radius:10px; width: 44px; height:44px; border:none; cursor:pointer" aria-label="Selecione cor" />
  <button id="btn-clear" title="Apagar tudo" aria-label="Apagar todo o desenho" style="margin-top:10px; border:none; border-radius:14px; background:#d62828; color:#fff; font-weight:700; cursor:pointer; padding: 10px;">üßπ Apagar Tudo</button>
</div>

<div id="image-palette" aria-label="Paleta de imagens para pintar">
  <h3>Imagens para Pintar</h3>
  <img src="https://cdn.pixabay.com/photo/2016/10/18/21/06/dinosaur-1784536_1280.jpg" class="palette-image" draggable="true" alt="Dinossauro" />
  <img src="https://cdn.pixabay.com/photo/2014/04/10/10/02/owl-319913_1280.jpg" class="palette-image" draggable="true" alt="Coruja" />
  <img src="https://cdn.pixabay.com/photo/2016/01/22/15/36/dog-1151516_1280.jpg" class="palette-image" draggable="true" alt="Cachorro" />
  <img src="https://cdn.pixabay.com/photo/2016/03/27/19/17/turtle-1280223_1280.jpg" class="palette-image" draggable="true" alt="Tartaruga" />
  <img src="https://cdn.pixabay.com/photo/2017/06/20/23/21/girl-2421590_1280.jpg" class="palette-image" draggable="true" alt="Garota" />
</div>

<div id="geom-palette" aria-label="Paleta de formas geom√©tricas para pintar">
  <h3>Formas Geom√©tricas</h3>
  <div class="geom-shape circle" draggable="true" aria-label="C√≠rculo"></div>
  <div class="geom-shape square" draggable="true" aria-label="Quadrado"></div>
  <div class="geom-shape triangle" draggable="true" aria-label="Tri√¢ngulo"></div>
</div>

<div id="canvas-container">
  <svg id="paint-area" viewBox="0 0 600 400" role="img" aria-label="√Årea de pintura">
    <!-- Contornos para balde preencher -->
    <path class="outline" d="M100 120 Q 160 50, 220 120 T 340 120" />
    <path class="outline" d="M400 180 Q 460 130, 520 180 T 580 190" />
    <!-- √Åreas ‚Äúvazias‚Äù para pintar com balde -->
    <path class="fillable" data-filled="false" d="M90 110 L350 110 L350 130 L90 130 Z" />
    <path class="fillable" data-filled="false" d="M390 170 L590 170 L590 200 L390 200 Z" />
  </svg>
</div>

<div id="undo-redo">
  <button class="undo-redo-btn" id="undo-btn" disabled aria-label="Desfazer √∫ltima a√ß√£o">‚Ü©Ô∏è Desfazer</button>
  <button class="undo-redo-btn" id="redo-btn" disabled aria-label="Refazer √∫ltima a√ß√£o">‚Ü™Ô∏è Refazer</button>
</div>

<script>
  const btnBack = document.getElementById('btn-back');
  btnBack.onclick = () => location.href = '../index.html';

  const tools = {
    pencil: document.getElementById('tool-pencil'),
    brush: document.getElementById('tool-brush'),
    eraser: document.getElementById('tool-eraser'),
    bucket: document.getElementById('tool-bucket'),
  };
  const colorPicker = document.getElementById('color-picker');
  const undoBtn = document.getElementById('undo-btn');
  const redoBtn = document.getElementById('redo-btn');
  const clearBtn = document.getElementById('btn-clear');
  let currentTool = 'pencil';
  let currentColor = colorPicker.value;

  const paintArea = document.getElementById('paint-area');
  const svgNS = "http://www.w3.org/2000/svg";
  let drawing = false;
  let currentPath = null;
  let pathData = '';

  // Undo / Redo stacks
  let undoStack = [];
  let redoStack = [];

  function selectTool(name) {
    currentTool = name;
    Object.entries(tools).forEach(([key, btn]) => {
      btn.classList.toggle('selected', key === name);
      btn.setAttribute('aria-pressed', key === name);
    });
  }
  Object.entries(tools).forEach(([key, btn]) => {
    btn.onclick = () => {
      selectTool(key);
      redoStack = [];
      updateUndoRedoButtons();
    }
  });

  colorPicker.oninput = e => currentColor = e.target.value;

  function pushUndo(action) {
    undoStack.push(action);
    if (undoStack.length > 50) undoStack.shift();
    redoStack = [];
    updateUndoRedoButtons();
  }

  undoBtn.onclick = () => {
    if (undoStack.length === 0) return;
    const last = undoStack.pop();
    if (last.type === 'draw' || last.type === 'erase' || last.type === 'image') {
      paintArea.removeChild(last.element);
      redoStack.push(last);
    } else if (last.type === 'fill') {
      last.element.setAttribute('fill', last.oldColor);
      last.element.setAttribute('data-filled', last.oldFilled);
      redoStack.push(last);
    } else if (last.type === 'clear') {
      last.elements.forEach(el => paintArea.appendChild(el));
      redoStack.push(last);
    }
    updateUndoRedoButtons();
  };

  redoBtn.onclick = () => {
    if (redoStack.length === 0) return;
    const last = redoStack.pop();
    if (last.type === 'draw' || last.type === 'erase' || last.type === 'image') {
      paintArea.appendChild(last.element);
      undoStack.push(last);
    } else if (last.type === 'fill') {
      last.element.setAttribute('fill', last.newColor);
      last.element.setAttribute('data-filled', 'true');
      undoStack.push(last);
    } else if (last.type === 'clear') {
      last.elements.forEach(el => paintArea.removeChild(el));
      undoStack.push(last);
    }
    updateUndoRedoButtons();
  };

  clearBtn.onclick = () => {
    const elementsToRemove = [...paintArea.querySelectorAll('path, image')].filter(el => !el.classList.contains('outline') && !el.classList.contains('fillable'));
    if(elementsToRemove.length === 0) return;
    elementsToRemove.forEach(el => paintArea.removeChild(el));
    pushUndo({type: 'clear', elements: elementsToRemove});
  };

  function updateUndoRedoButtons() {
    undoBtn.disabled = undoStack.length === 0;
    redoBtn.disabled = redoStack.length === 0;
  }

  // Drawing handlers
  paintArea.addEventListener('mousedown', e => {
    if (currentTool === 'bucket') return;
    if (e.target.classList.contains('palette-image') || e.target.tagName === 'image') return;
    drawing = true;
    const pt = getSVGPoint(e);
    pathData = `M ${pt.x} ${pt.y}`;
    currentPath = document.createElementNS(svgNS, 'path');
    currentPath.setAttribute('fill', 'none');
    currentPath.setAttribute('stroke', currentTool === 'eraser' ? '#fff' : currentColor);
    currentPath.setAttribute('stroke-width', currentTool === 'brush' ? '8' : (currentTool === 'eraser' ? '12' : '2'));
    currentPath.setAttribute('stroke-linejoin', 'round');
    currentPath.setAttribute('stroke-linecap', 'round');
    currentPath.setAttribute('d', pathData);
    paintArea.appendChild(currentPath);
    pushUndo({ type: currentTool === 'eraser' ? 'erase' : 'draw', element: currentPath });
  });
  paintArea.addEventListener('mousemove', e => {
    if (!drawing || !currentPath) return;
    const pt = getSVGPoint(e);
    pathData += ` L ${pt.x} ${pt.y}`;
    currentPath.setAttribute('d', pathData);
  });
  function stopDrawing() {
    drawing = false;
    currentPath = null;
  }
  paintArea.addEventListener('mouseup', stopDrawing);
  paintArea.addEventListener('mouseleave', stopDrawing);

  // Bucket fill support - preencher 'fillable' paths with data-filled attribute
  paintArea.querySelectorAll('path.fillable').forEach(path => {
    path.addEventListener('click', e => {
      if (currentTool !== 'bucket') return;
      const oldColor = path.getAttribute('fill') || 'white';
      const oldFilled = path.getAttribute('data-filled') || 'false';
      path.setAttribute('fill', currentColor);
      path.setAttribute('data-filled', 'true');
      pushUndo({ type: 'fill', element: path, oldColor: oldColor, newColor: currentColor, oldFilled: oldFilled });
    });
  });

  // Drag & drop images palette into SVG and enable dragging inside SVG
  const paletteImages = document.querySelectorAll('.palette-image');
  paletteImages.forEach(img => {
    img.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', e.target.src);
    });
  });

  paintArea.addEventListener('dragover', e => e.preventDefault());
  paintArea.addEventListener('drop', e => {
    e.preventDefault();
    const url = e.dataTransfer.getData('text/plain');
    if (url) {
      const pt = getSVGPoint(e);
      const img = document.createElementNS(svgNS, 'image');
      img.setAttributeNS('http://www.w3.org/1999/xlink', 'href', url);
      img.setAttribute('x', pt.x - 50);
      img.setAttribute('y', pt.y - 50);
      img.setAttribute('height', 100);
      img.setAttribute('width', 100);
      img.style.cursor = 'grab';
      paintArea.appendChild(img);
      pushUndo({ type: 'image', element: img });
      makeSVGDraggable(img);
    }
  });

  // Drag dragging support for images inside SVG
  function makeSVGDraggable(element) {
    let dragging = false;
    let offsetX, offsetY;

    element.addEventListener('mousedown', e => {
      e.preventDefault();
      dragging = true;
      const pt = getSVGPoint(e);
      offsetX = pt.x - parseFloat(element.getAttribute('x'));
      offsetY = pt.y - parseFloat(element.getAttribute('y'));
      element.style.cursor = 'grabbing';
    });
    paintArea.addEventListener('mousemove', e => {
      if (dragging) {
        const pt = getSVGPoint(e);
        element.setAttribute('x', pt.x - offsetX);
        element.setAttribute('y', pt.y - offsetY);
      }
    });
    paintArea.addEventListener('mouseup', e => {
      if (dragging) {
        dragging = false;
        element.style.cursor = 'grab';
      }
    });
    paintArea.addEventListener('mouseleave', e => {
      if (dragging) {
        dragging = false;
        element.style.cursor = 'grab';
      }
    });
  }

  function getSVGPoint(event) {
    const pt = paintArea.createSVGPoint();
    pt.x = event.clientX;
    pt.y = event.clientY;
    return pt.matrixTransform(paintArea.getScreenCTM().inverse());
  }
</script>
</body>
</html>
