<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jogo de Pintura - Musi Kids Fun</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Baloo&display=swap');
  html, body {
    margin: 0; padding: 0; height: 100%;
    background: linear-gradient(135deg, #f9ecd3 0%, #f4a261 100%);
    font-family: 'Baloo', cursive, Arial, sans-serif;
    user-select: none;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  header {
    font-size: 2rem;
    color: #d76f51;
    font-weight: 900;
    text-align: center;
    padding: 10px 0;
    background: #e9c46a;
    box-shadow: 0 3px 6px rgba(187,133,97,0.67);
    user-select: none;
  }
  #btn-back {
    position: fixed;
    top: 10px;
    left: 10px;
    background: #2a9d8f;
    color: white;
    padding: 10px 18px;
    font-weight: 700;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    box-shadow: 0 6px 15px rgba(42,157,143,0.8);
    z-index: 1000;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  #btn-back:hover {
    background: #21867a;
  }
  #top-bar {
    position: fixed;
    top: 10px;
    left: 60px;
    right: 20px;
    height: 54px;
    background: rgba(38, 70, 83, 0.9);
    border-radius: 25px;
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 0 12px;
    z-index: 900;
  }
  #top-bar button, #top-bar input[type=color] {
    height: 40px;
    border-radius: 12px;
    border: none;
    font-size: 20px;
    cursor: pointer;
    user-select: none;
    padding: 0 12px;
    background: #2a9d8f;
    color: white;
    transition: background-color 0.3s ease;
  }
  #top-bar button:hover, #top-bar input[type=color]:hover {
    background: #21867a;
  }
  #top-bar button:disabled {
    background: #555;
    cursor: not-allowed;
  }
  #toolbar {
    position: fixed;
    top: 70px;
    left: 10px;
    width: 52px;
    background: rgba(38,70,83,0.9);
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 10px 6px;
    z-index: 900;
  }
  .tool-btn {
    width: 44px;
    height: 44px;
    border-radius: 14px;
    border: none;
    background: #ffffffcc;
    color: #264653;
    font-size: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    user-select: none;
    box-shadow: 0 4px 9px rgba(0,0,0,0.2);
    transition: background-color 0.2s ease;
  }
  .tool-btn.selected {
    background: #2a9d8f;
    color: white;
  }
  .tool-btn:hover {
    background: #d8f3dc;
  }
  #color-picker {
    width: 44px;
    height: 44px;
    border-radius: 14px;
    border: none;
    margin-top: 6px;
    cursor: pointer;
  }
  #palette-container {
    position: fixed;
    top: 140px;
    left: 10px;
    width: 60px;
    max-height: 44vh;
    overflow-y: auto;
    background: rgba(255, 182, 132, 0.9);
    border-radius: 20px;
    padding: 10px 5px;
    z-index: 900;
  }
  #palette-container .palette-item {
    width: 44px;
    height: 44px;
    margin: 8px auto;
    cursor: grab;
    border-radius: 12px;
    box-shadow: 0 3px 7px rgba(168,84,14,0.7);
  }
  #palette-container .shape-item {
    display: flex;
    justify-content: center;
    align-items: center;
    background: #f3722c;
    color: white;
    font-size: 26px;
    user-select: none;
  }
  #palette-container .circle {
    border-radius: 50%;
  }
  #palette-container .triangle {
    width: 0;
    height: 0;
    border-left: 22px solid transparent;
    border-right: 22px solid transparent;
    border-bottom: 38px solid #f9844a;
    margin-top: 8px;
    margin-bottom: 8px;
  }
  #paint-area-container {
    margin-left: 80px;
    margin-top: 70px;
    flex-grow: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: auto;
  }
  svg#paint-area {
    border-radius: 16px;
    border: 3px solid #264653;
    background: #fff9f0;
    max-width: 90vw;
    max-height: 80vh;
    display: block;
    user-select: none;
  }
  path.outline {
    stroke: #264653;
    stroke-width: 3;
    fill: none;
    pointer-events: none;
  }
  path.fillable {
    cursor: pointer;
    stroke: #264653;
    stroke-width: 2;
    fill: white;
  }
</style>
<body>

<button id="btn-back" aria-label="Voltar ao menu" title="Voltar ao menu">‚Üê Menu</button>

<div id="top-bar" role="toolbar" aria-label="Controles do desenho">
  <button id="undo-btn" title="Desfazer" disabled>‚Ü©Ô∏è</button>
  <button id="redo-btn" title="Refazer" disabled>‚Ü™Ô∏è</button>
  <button id="clear-btn" title="Apagar tudo">üßπ</button>
  <input id="color-picker" type="color" value="#ff4a74" title="Selecionar cor" aria-label="Selecionar cor"/>
</div>

<div id="toolbar" role="toolbar" aria-label="Ferramentas">
  <button class="tool-btn selected" id="tool-pencil" title="L√°pis" aria-pressed="true">‚úèÔ∏è</button>
  <button class="tool-btn" id="tool-brush" title="Pincel" aria-pressed="false">üñåÔ∏è</button>
  <button class="tool-btn" id="tool-eraser" title="Borracha" aria-pressed="false">ü©π</button>
  <button class="tool-btn" id="tool-bucket" title="Balde" aria-pressed="false">ü™£</button>
</div>

<div id="palette-container" aria-label="Paleta de imagens e figuras">
  <img src="https://cdn.pixabay.com/photo/2016/10/18/21/06/dinosaur-1784536_1280.jpg" class="palette-item" draggable="true" alt="Dinossauro" />
  <img src="https://cdn.pixabay.com/photo/2014/04/10/10/02/owl-319913_1280.jpg" class="palette-item" draggable="true" alt="Coruja" />
  <img src="https://cdn.pixabay.com/photo/2016/01/22/15/36/dog-1151516_1280.jpg" class="palette-item" draggable="true" alt="Cachorro" />
  <img src="https://cdn.pixabay.com/photo/2016/03/27/19/17/turtle-1280223_1280.jpg" class="palette-item" draggable="true" alt="Tartaruga" />
  <img src="https://cdn.pixabay.com/photo/2017/06/20/23/21/girl-2421590_1280.jpg" class="palette-item" draggable="true" alt="Garota" />
  <div class="palette-item circle" draggable="true" title="C√≠rculo"></div>
  <div class="palette-item triangle" draggable="true" title="Tri√¢ngulo"></div>
  <div class="palette-item" draggable="true" title="Quadrado" style="border-radius: 12px; background: #f3722c; height:44px;"></div>
</div>

<div id="paint-area-container">
  <svg id="paint-area" viewBox="0 0 600 400" role="img" aria-label="√Årea de pintura">
    <path class="outline" d="M100 120 Q 160 50, 220 120 T 340 120" />
    <path class="outline" d="M400 180 Q 460 130, 520 180 T 580 190" />
    <path class="fillable" d="M90 110 L350 110 L350 130 L90 130 Z" />
    <path class="fillable" d="M390 170 L590 170 L590 200 L390 200 Z" />
  </svg>
</div>

<script>
  const btnBack = document.getElementById('btn-back');
  btnBack.onclick = () => location.href = '../index.html';

  const tools = {
    pencil: document.getElementById('tool-pencil'),
    brush: document.getElementById('tool-brush'),
    eraser: document.getElementById('tool-eraser'),
    bucket: document.getElementById('tool-bucket'),
  };
  const colorPicker = document.getElementById('color-picker');
  const undoBtn = document.getElementById('undo-btn');
  const redoBtn = document.getElementById('redo-btn');
  const clearBtn = document.getElementById('clear-btn');
  const paintArea = document.getElementById('paint-area');
  const svgNS = "http://www.w3.org/2000/svg";

  let currentTool = 'pencil';
  let currentColor = colorPicker.value;
  let drawing = false;
  let currentPath = null;
  let pathData = '';

  let undoStack = [];
  let redoStack = [];

  function updateUndoRedoButtons(){
    undoBtn.disabled = undoStack.length === 0;
    redoBtn.disabled = redoStack.length === 0;
  }

  function pushUndo(action){
    undoStack.push(action);
    if(undoStack.length > 50) undoStack.shift();
    redoStack = [];
    updateUndoRedoButtons();
  }

  undoBtn.onclick = () => {
    if(undoStack.length === 0) return;
    const action = undoStack.pop();
    if(action.type === 'draw' || action.type === 'erase' || action.type === 'image') {
      paintArea.removeChild(action.element);
      redoStack.push(action);
    }
    else if(action.type === 'fill'){
      action.element.setAttribute('fill', action.oldColor);
      action.element.setAttribute('data-filled', action.oldFilled);
      redoStack.push(action);
    }
    else if(action.type === 'clear'){
      action.elements.forEach(el => paintArea.appendChild(el));
      redoStack.push(action);
    }
    updateUndoRedoButtons();
  };

  redoBtn.onclick = () => {
    if(redoStack.length === 0) return;
    const action = redoStack.pop();
    if(action.type === 'draw' || action.type === 'erase' || action.type === 'image'){
      paintArea.appendChild(action.element);
      undoStack.push(action);
    }
    else if(action.type === 'fill'){
      action.element.setAttribute('fill', action.newColor);
      action.element.setAttribute('data-filled', 'true');
      undoStack.push(action);
    }
    else if(action.type === 'clear'){
      action.elements.forEach(el => paintArea.removeChild(el));
      undoStack.push(action);
    }
    updateUndoRedoButtons();
  };

  clearBtn.onclick = () => {
    const allDrawn = [...paintArea.querySelectorAll('path, image')].filter(el => !el.classList.contains('outline') && !el.classList.contains('fillable'));
    if(allDrawn.length === 0) return;
    allDrawn.forEach(el => paintArea.removeChild(el));
    pushUndo({type:'clear', elements: allDrawn});
  };

  colorPicker.oninput = (e) => {
    currentColor = e.target.value;
  };

  function selectTool(name){
    currentTool = name;
    for(let key in tools){
      tools[key].classList.toggle('selected', key === name);
      tools[key].setAttribute('aria-pressed', key === name ? 'true' : 'false');
    }
    redoStack = [];
    updateUndoRedoButtons();
  }

  for(let key in tools){
    tools[key].addEventListener('click', () => selectTool(key));
  }
  selectTool('pencil');

  // Drawing logic
  paintArea.addEventListener('mousedown', e => {
    if(currentTool === 'bucket') return;
    if(e.target.classList.contains('palette-item') || e.target.tagName === 'image') return;
    drawing = true;
    const pt = getSVGPoint(e);
    pathData = `M ${pt.x} ${pt.y}`;
    currentPath = document.createElementNS(svgNS, 'path');
    currentPath.setAttribute('fill', 'none');
    currentPath.setAttribute('stroke', currentTool === 'eraser' ? '#fff' : currentColor);
    currentPath.setAttribute('stroke-width', currentTool === 'brush' ? '8' : (currentTool === 'eraser' ? '12' : '2'));
    currentPath.setAttribute('stroke-linejoin', 'round');
    currentPath.setAttribute('stroke-linecap', 'round');
    currentPath.setAttribute('d', pathData);
    paintArea.appendChild(currentPath);
    pushUndo({type: currentTool === 'eraser' ? 'erase' : 'draw', element: currentPath});
  });

  paintArea.addEventListener('mousemove', e => {
    if(!drawing || !currentPath) return;
    const pt = getSVGPoint(e);
    pathData += ` L ${pt.x} ${pt.y}`;
    currentPath.setAttribute('d', pathData);
  });

  function stopDrawing(){
    drawing = false;
    currentPath = null;
  }

  paintArea.addEventListener('mouseup', stopDrawing);
  paintArea.addEventListener('mouseleave', stopDrawing);

  // Bucket fill function
  paintArea.querySelectorAll('path.fillable').forEach(path => {
    path.addEventListener('click', e => {
      if(currentTool !== 'bucket') return;
      const el = e.target;
      const oldCol = el.getAttribute('fill') || 'none';
      const oldFill = el.getAttribute('data-filled') || 'false';

      if(oldCol.toLowerCase() === currentColor.toLowerCase() && oldFill==='true') return;

      el.setAttribute('fill', currentColor);
      el.setAttribute('data-filled', 'true');

      pushUndo({type: 'fill', element: el, oldColor: oldCol, newColor: currentColor, oldFilled: oldFill});
    });
  });

  // Drag & drop from palette to SVG
  const paletteItems = document.querySelectorAll('.palette-item, .palette-item.circle, .palette-item.triangle, .palette-item.square');
  paletteItems.forEach(item => {
    item.addEventListener('dragstart', e => {
      if(e.target.classList.contains('palette-item')){
        e.dataTransfer.setData('text/plain', e.target.src);
      } else {
        e.dataTransfer.setData('text/plain', e.target.className.baseVal || e.target.className);
      }
    });
  });

  paintArea.addEventListener('dragover', e => e.preventDefault());
  paintArea.addEventListener('drop', e => {
    e.preventDefault();
    const data = e.dataTransfer.getData('text/plain');
    if(!data) return;

    const pt = getSVGPoint(e);

    if(data.startsWith('http') || data.match(/\.(png|jpg|jpeg|gif|svg)$/i)){
      // image dragged
      const newImg = document.createElementNS(svgNS, 'image');
      newImg.setAttribute('href', data);
      newImg.setAttribute('x', pt.x - 50);
      newImg.setAttribute('y', pt.y - 50);
      newImg.setAttribute('width', 100);
      newImg.setAttribute('height', 100);
      newImg.style.cursor = 'grab';
      paintArea.appendChild(newImg);

      pushUndo({type: 'image', element: newImg});
      makeDraggable(newImg);
    } else {
      // Shape dragged
      let shapeEl;
      if(data.includes('circle')){
        shapeEl = document.createElementNS(svgNS, 'circle');
        shapeEl.setAttribute('cx', pt.x);
        shapeEl.setAttribute('cy', pt.y);
        shapeEl.setAttribute('r', 50);
        shapeEl.setAttribute('fill', currentColor);
        shapeEl.setAttribute('stroke', '#264653');
        shapeEl.setAttribute('stroke-width', 3);
      } else if(data.includes('square')){
        shapeEl = document.createElementNS(svgNS, 'rect');
        shapeEl.setAttribute('x', pt.x - 50);
        shapeEl.setAttribute('y', pt.y - 50);
        shapeEl.setAttribute('width', 100);
        shapeEl.setAttribute('height', 100);
        shapeEl.setAttribute('fill', currentColor);
        shapeEl.setAttribute('stroke', '#264653');
        shapeEl.setAttribute('stroke-width', 3);
        shapeEl.setAttribute('rx', 10);
        shapeEl.setAttribute('ry', 10);
      } else if(data.includes('triangle')){
        shapeEl = document.createElementNS(svgNS, 'polygon');
        shapeEl.setAttribute('points',
          `${pt.x},${pt.y - 58} ${pt.x - 50},${pt.y + 42} ${pt.x + 50},${pt.y + 42}`);
        shapeEl.setAttribute('fill', currentColor);
        shapeEl.setAttribute('stroke', '#264653');
        shapeEl.setAttribute('stroke-width', 3);
      }

      if(shapeEl){
        shapeEl.style.cursor = 'grab';
        paintArea.appendChild(shapeEl);
        pushUndo({type: 'image', element: shapeEl});
        makeDraggable(shapeEl);
      }
    }
  });

  function makeDraggable(el){
    let dragging = false;
    let offsetX, offsetY;

    el.addEventListener('mousedown', e => {
      e.preventDefault();
      dragging = true;
      const pt = getSVGPoint(e);
      if(el.tagName === "circle"){
        offsetX = pt.x - parseFloat(el.getAttribute('cx'));
        offsetY = pt.y - parseFloat(el.getAttribute('cy'));
      } else {
        offsetX = pt.x - parseFloat(el.getAttribute('x'));
        offsetY = pt.y - parseFloat(el.getAttribute('y'));
      }
      el.style.cursor = 'grabbing';
    });

    paintArea.addEventListener('mousemove', e => {
      if(!dragging) return;
      const pt = getSVGPoint(e);
      if(el.tagName === "circle"){
        el.setAttribute('cx', pt.x - offsetX);
        el.setAttribute('cy', pt.y - offsetY);
      } else {
        el.setAttribute('x', pt.x - offsetX);
        el.setAttribute('y', pt.y - offsetY);
      }
    });

    paintArea.addEventListener('mouseup', e => {
      if(dragging){
        dragging = false;
        el.style.cursor = 'grab';
      }
    });
    paintArea.addEventListener('mouseleave', e => {
      if(dragging){
        dragging = false;
        el.style.cursor = 'grab';
      }
    });
  }

  function getSVGPoint(evt){
    const pt = paintArea.createSVGPoint();
    pt.x = evt.clientX;
    pt.y = evt.clientY;
    return pt.matrixTransform(paintArea.getScreenCTM().inverse());
  }
</script>
</body>
</html>
