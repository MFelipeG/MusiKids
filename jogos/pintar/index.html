<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jogo de Pintura - Musi Kids</title>
<style>
  /* Estilos gerais */
  @import url('https://fonts.googleapis.com/css2?family=Baloo&display=swap');
  html, body {
    margin: 0; padding: 0; height: 100%;
    background: linear-gradient(135deg, #f9ecd3 0%, #f4a261 100%);
    font-family: 'Baloo', cursive, Arial, sans-serif;
    user-select: none;
    overflow: hidden;
    display: flex; flex-direction: column;
  }
  header { /* Mantido para poss√≠vel uso futuro, mas n√£o vis√≠vel no layout atual */
    font-size: 2rem; font-weight: 900;
    text-align: center; padding: 10px 0;
    background: #e2a343; color: #5B4215; user-select: none;
  }
  #btn-back {
    position: fixed; top: 10px; left: 10px;
    background: #3B7994; color: white;
    border: none; border-radius: 20px;
    padding: 12px 20px;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 6px 15px rgba(0,0,0,0.4);
    z-index: 1000; user-select: none;
    transition: background-color 0.3s ease;
  }
  #btn-back:hover { background: #305f71; }

  /* Ferramentas laterais externas */
  #toolbar {
    position: fixed; top: 70px; left: 10px; width: 64px;
    background: rgba(59, 121, 148, 0.9);
    border-radius: 25px; padding: 10px 6px;
    display: flex; flex-direction: column; gap: 15px;
    align-items: center;
    z-index: 998; user-select: none;
  }
  .tool-btn {
    width: 48px; height: 48px; border-radius: 20px;
    border: none; background: #def3f3; color: #185359;
    font-size: 26px; cursor: pointer;
    display: flex; justify-content: center; align-items: center;
    box-shadow: 0 5px 12px rgba(24, 83, 62, 0.3);
    transition: background-color 0.3s ease;
  }
  .tool-btn.selected {
    background: #185359; color: white;
  }
  .tool-btn:hover {
    background: #a2c1c1; color: #173e3f;
  }
  #color-picker {
    margin-top: 10px;
    width: 44px; height: 44px;
    border-radius: 22px;
    border: none;
    cursor: pointer;
  }
  /* Escala para formas geom√©tricas */
  #scale-controls {
    margin-top: 10px;
    display: none; /* Escondido por padr√£o, aparece ao selecionar uma forma */
    flex-direction: column;
    gap: 6px;
  }
  .scale-btn {
    width: 42px; height: 28px;
    background: #185359;
    color: white; border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: 800;
    user-select: none;
  }
  .scale-btn:active {
    background: #0f3c3a;
  }

  /* Paletas direita de imagens e formas */
  #palette-container {
    position: fixed; top: 70px; right: 10px; /* Ajustado para nova altura */
    width: 210px; max-height: calc(100vh - 80px); /* Ajustado para nova altura */
    background: #fdeed6cc;
    border-radius: 20px;
    box-shadow: 0 5px 18px rgba(168, 84, 14, 0.7);
    padding: 10px;
    overflow-y: auto;
    z-index: 997;
  }
  #palette-container h3 {
    color: #B45105;
    font-weight: 700;
    margin: 0 0 12px 0;
    text-align: center;
    user-select: none;
  }
  .palette-item, .palette-shape {
    width: 90%;
    margin: 6px auto;
    cursor: grab;
    border-radius: 14px;
    box-shadow: 0 4px 11px rgba(168, 84, 14, 0.6);
    user-select: none;
    display: block;
    background-color: white;
  }
   .palette-item {
    padding: 5px;
    box-sizing: border-box;
  }
  .palette-shape {
    height: 75px;
    border: 2px solid black;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .palette-shape.circle {
    border-radius: 100%;
  }
  .palette-shape.triangle {
    width: 0;
    height: 0;
    background-color: transparent;
    border-left: 38px solid transparent;
    border-right: 38px solid transparent;
    border-bottom: 68px solid black;
    margin-top: 8px;
    margin-bottom: 8px;
    border-top: none;
    border-radius: 0;
  }
  /* Pintura */
  #paint-area-container {
    margin-left: 80px;
    margin-right: 230px; /* Espa√ßo para a paleta da direita */
    margin-top: 20px;
    flex-grow: 1;
    overflow: auto;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative; /* Necess√°rio para posicionar o undo/redo */
  }
  #undo-redo-container {
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      z-index: 10;
      background: rgba(59, 121, 148, 0.9);
      padding: 8px 15px;
      border-radius: 25px;
  }
  #undo-redo-container button {
      background: #4ea6c1;
      border: none; border-radius: 20px;
      padding: 6px 16px;
      color: white;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      transition: background-color 0.3s ease;
      font-family: 'Baloo', cursive;
  }
  #undo-redo-container button:disabled {
      background: #97bccd;
      cursor: not-allowed;
  }
   #undo-redo-container button:not(:disabled):hover {
    background: #357d9b;
  }
  
  svg#paint-area {
    border-radius: 20px;
    border: 4px solid #185359;
    background: white;
    width: 95%;
    height: 95%;
    display: block;
    user-select: none;
  }

  /* Estilo para forma selecionada */
  .selected-shape {
      outline: 3px dashed #3B7994;
      outline-offset: 4px;
  }
</style>
</head>
<body>
  <button id="btn-back" aria-label="Menu de jogos" title="Voltar para Menu de Jogos">MENU DE JOGOS</button>

  <div id="toolbar" role="toolbar" aria-label="Ferramentas">
    <button class="tool-btn selected" id="tool-pencil" aria-pressed="true" aria-label="Selecionar l√°pis">‚úèÔ∏è</button>
    <button class="tool-btn" id="tool-eraser" aria-pressed="false" aria-label="Selecionar borracha">ü©π</button>
    <button class="tool-btn" id="tool-brush" aria-pressed="false" aria-label="Selecionar pincel">üñåÔ∏è</button>
    <button class="tool-btn" id="tool-bucket" aria-pressed="false" aria-label="Selecionar balde de tinta">üíß</button>
    
    <div id="scale-controls">
      <button class="scale-btn" id="scale-increase" aria-label="Aumentar tamanho">Ôºã</button>
      <button class="scale-btn" id="scale-decrease" aria-label="Diminuir tamanho">‚àí</button>
    </div>
    <input type="color" id="color-picker" aria-label="Escolher cor" value="#000000" />
  </div>

  <div id="palette-container" aria-label="Paletas de imagens e formas">
    <h3>Imagens para pintar</h3>
    <img src="https://i.imgur.com/u1VLkNj.png" class="palette-item" draggable="true" alt="Dinossauro para colorir" />
    <img src="https://i.imgur.com/xIuBv3y.png" class="palette-item" draggable="true" alt="Coruja para colorir" />
    <img src="https://i.imgur.com/fL3xQ7B.png" class="palette-item" draggable="true" alt="Cachorro para colorir" />
    <img src="https://i.imgur.com/gK9fI8H.png" class="palette-item" draggable="true" alt="Tartaruga para colorir" />
    <img src="https://i.imgur.com/o2Y0Z4j.png" class="palette-item" draggable="true" alt="Garota para colorir" />
    
    <h3 style="margin-top: 20px;">Formas Geom√©tricas</h3>
    <div class="palette-shape circle" draggable="true" role="img" aria-label="C√≠rculo"></div>
    <div class="palette-shape square" draggable="true" role="img" aria-label="Quadrado"></div>
    <div class="palette-shape triangle" draggable="true" role="img" aria-label="Tri√¢ngulo"></div>
  </div>

  <div id="paint-area-container">
    <div id="undo-redo-container">
        <button id="undo-btn" disabled aria-label="Desfazer">‚Ü©Ô∏è Desfazer</button>
        <button id="redo-btn" disabled aria-label="Refazer">‚Ü™Ô∏è Refazer</button>
    </div>
    <svg id="paint-area" viewBox="0 0 800 600" role="img" aria-label="√Årea para pintar" tabindex="0">
       </svg>
  </div>

  <script>
    const paintArea = document.getElementById("paint-area");
    const svgNS = "http://www.w3.org/2000/svg";

    const btnBack = document.getElementById("btn-back");
    const tools = {
      pencil: document.getElementById("tool-pencil"),
      eraser: document.getElementById("tool-eraser"),
      brush: document.getElementById("tool-brush"),
      bucket: document.getElementById("tool-bucket"), // Ferramenta balde adicionada
    };
    const scaleControls = document.getElementById("scale-controls");
    const scaleIncrease = document.getElementById("scale-increase");
    const scaleDecrease = document.getElementById("scale-decrease");

    const colorPicker = document.getElementById("color-picker");
    const undoBtn = document.getElementById("undo-btn");
    const redoBtn = document.getElementById("redo-btn");

    let currentTool = "pencil";
    let currentColor = colorPicker.value;
    let isDrawing = false;
    let currentPath = null;
    let pathData = "";

    let selectedElement = null; // Elemento selecionado (para arrastar e escalar)
    let undoStack = [];
    let redoStack = [];

    // --- Fun√ß√µes de Sele√ß√£o e Escala ---
    function deselectAll() {
        if (selectedElement) {
            selectedElement.classList.remove("selected-shape");
            selectedElement = null;
        }
        scaleControls.style.display = "none";
    }

    function selectElement(el) {
        deselectAll();
        selectedElement = el;
        selectedElement.classList.add("selected-shape");
        scaleControls.style.display = "flex";
    }

    function scaleSelected(factor) {
        if (!selectedElement) return;

        const el = selectedElement;
        // Usa o atributo transform para escalar, que funciona em todos os elementos SVG
        let currentTransform = el.getAttribute("transform") || "";
        let scaleMatch = currentTransform.match(/scale\(([^)]+)\)/);
        let currentScale = scaleMatch ? parseFloat(scaleMatch[1]) : 1;
        
        let newScale = currentScale * factor;
        if (newScale < 0.1 || newScale > 10) return; // Limites de escala

        // Remove a escala antiga e adiciona a nova
        let otherTransforms = currentTransform.replace(/scale\([^)]+\)/, '').trim();
        el.setAttribute("transform", `${otherTransforms} scale(${newScale})`);
    }

    scaleIncrease.addEventListener("click", () => scaleSelected(1.1));
    scaleDecrease.addEventListener("click", () => scaleSelected(0.9));


    // --- Fun√ß√µes de Desfazer/Refazer (Undo/Redo) ---
    function updateUndoRedoButtons() {
      undoBtn.disabled = undoStack.length === 0;
      redoBtn.disabled = redoStack.length === 0;
    }

    function pushUndo(action) {
      undoStack.push(action);
      if (undoStack.length > 50) undoStack.shift();
      redoStack = [];
      updateUndoRedoButtons();
    }

    undoBtn.addEventListener("click", () => {
      if (undoStack.length === 0) return;
      const action = undoStack.pop();
      if (action.type === 'add') {
        paintArea.removeChild(action.element);
      } else if (action.type === 'fill') {
        action.element.setAttribute("fill", action.oldColor);
      }
      redoStack.push(action);
      updateUndoRedoButtons();
    });

    redoBtn.addEventListener("click", () => {
      if (redoStack.length === 0) return;
      const action = redoStack.pop();
      if (action.type === 'add') {
        paintArea.appendChild(action.element);
      } else if (action.type === 'fill') {
        action.element.setAttribute("fill", action.newColor);
      }
      undoStack.push(action);
      updateUndoRedoButtons();
    });

    btnBack.onclick = () => { location.href = "../"; };

    // --- L√≥gica das Ferramentas ---
    function selectTool(tool) {
      currentTool = tool;
      for (const key in tools) {
        if (tools[key]) {
          tools[key].classList.toggle("selected", key === tool);
          tools[key].setAttribute("aria-pressed", key === tool ? "true" : "false");
        }
      }
       // Deseleciona qualquer forma se trocar para uma ferramenta de desenho
      if (['pencil', 'eraser', 'brush', 'bucket'].includes(tool)) {
          deselectAll();
      }
    }

    for (const key in tools) {
      if (tools[key]) {
        tools[key].addEventListener("click", () => selectTool(key));
      }
    }
    selectTool("pencil");

    colorPicker.addEventListener("input", (e) => { currentColor = e.target.value; });
    
    // --- L√≥gica de Desenho e Balde de Tinta ---
    function getSVGPoint(e) {
        const pt = paintArea.createSVGPoint();
        pt.x = e.clientX;
        pt.y = e.clientY;
        return pt.matrixTransform(paintArea.getScreenCTM().inverse());
    }

    paintArea.addEventListener("mousedown", (e) => {
        // CORRE√á√ÉO: S√≥ desenha se clicar no fundo da √°rea de pintura
        if (e.target !== paintArea) return;
        
        deselectAll(); // Deseleciona formas ao clicar no fundo

        if (['pencil', 'eraser', 'brush'].includes(currentTool)) {
            isDrawing = true;
            const pt = getSVGPoint(e);
            pathData = `M ${pt.x} ${pt.y}`;
            currentPath = document.createElementNS(svgNS, "path");
            currentPath.setAttribute("fill", "none");
            currentPath.setAttribute("stroke", currentTool === "eraser" ? "#fff" : currentColor);
            currentPath.setAttribute("stroke-width", currentTool === "brush" ? 12 : currentTool === "eraser" ? 20 : 3);
            currentPath.setAttribute("stroke-linejoin", "round");
            currentPath.setAttribute("stroke-linecap", "round");
            currentPath.setAttribute("d", pathData);
            paintArea.appendChild(currentPath);
        }
    });

    paintArea.addEventListener("mousemove", (e) => {
      if (!isDrawing || !currentPath) return;
      const pt = getSVGPoint(e);
      pathData += ` L ${pt.x} ${pt.y}`;
      currentPath.setAttribute("d", pathData);
    });
    
    const endDrawing = () => {
        if (isDrawing) {
            pushUndo({ type: 'add', element: currentPath });
            isDrawing = false;
            currentPath = null;
        }
    };

    paintArea.addEventListener("mouseup", endDrawing);
    paintArea.addEventListener("mouseleave", endDrawing);

    // CORRE√á√ÉO: L√≥gica do balde de tinta usando delega√ß√£o de evento
    paintArea.addEventListener("click", (e) => {
        if (currentTool !== 'bucket') return;
        const target = e.target;
        // Pinta qualquer forma (rect, circle, polygon) ou paths fechados
        if (['rect', 'circle', 'polygon', 'path'].includes(target.tagName.toLowerCase())) {
            const oldColor = target.getAttribute('fill') || 'none';
            if (oldColor === currentColor) return; // N√£o faz nada se j√° for da mesma cor

            target.setAttribute('fill', currentColor);
            pushUndo({ type: 'fill', element: target, oldColor: oldColor, newColor: currentColor });
        }
    });


    // --- L√≥gica de Arrastar e Soltar (Drag and Drop) ---
    document.querySelectorAll(".palette-item, .palette-shape").forEach((item) => {
      item.addEventListener("dragstart", (e) => {
        const payload = {
            type: item.classList.contains("palette-item") ? "image" : "shape",
            src: item.src || null,
            shape: [...item.classList].find((c) => ["circle", "square", "triangle"].includes(c)),
        };
        e.dataTransfer.setData("application/json", JSON.stringify(payload));
      });
    });

    paintArea.addEventListener("dragover", (e) => e.preventDefault());

    paintArea.addEventListener("drop", (e) => {
        e.preventDefault();
        let data;
        try {
            data = JSON.parse(e.dataTransfer.getData("application/json"));
        } catch (err) { return; }

        const pt = getSVGPoint(e);
        let el;

        if (data.type === "image" && data.src) {
            el = document.createElementNS(svgNS, "image");
            el.setAttribute("href", data.src);
            el.setAttribute("x", pt.x - 75);
            el.setAttribute("y", pt.y - 75);
            el.setAttribute("width", 150);
            el.setAttribute("height", 150);
        } else if (data.type === "shape" && data.shape) {
            if (data.shape === "circle") {
                el = document.createElementNS(svgNS, "circle");
                el.setAttribute("cx", pt.x);
                el.setAttribute("cy", pt.y);
                el.setAttribute("r", 50);
            } else if (data.shape === "square") {
                el = document.createElementNS(svgNS, "rect");
                el.setAttribute("x", pt.x - 50);
                el.setAttribute("y", pt.y - 50);
                el.setAttribute("width", 100);
                el.setAttribute("height", 100);
                el.setAttribute("rx", 10);
            } else if (data.shape === "triangle") {
                el = document.createElementNS(svgNS, "polygon");
                const size = 60;
                el.setAttribute("points", `${pt.x},${pt.y - size} ${pt.x - size},${pt.y + size} ${pt.x + size},${pt.y + size}`);
            }
            if(el) {
                el.setAttribute("fill", "white");
                el.setAttribute("stroke", "black");
                el.setAttribute("stroke-width", 3);
            }
        }
        
        if (el) {
            el.style.cursor = "grab";
            paintArea.appendChild(el);
            pushUndo({ type: 'add', element: el });
            makeDraggableAndSelectable(el);
        }
    });

    function makeDraggableAndSelectable(el) {
        let isDragging = false;
        let offset;

        el.addEventListener("mousedown", (e) => {
            // CORRE√á√ÉO: Impede o evento de chegar na √°rea de pintura, evitando o desenho de linhas
            e.stopPropagation(); 
            
            // Permite arrastar apenas com a ferramenta de l√°pis/pincel (para mover)
            if(['pencil', 'brush'].includes(currentTool)) {
                selectTool('pencil'); // Muda para uma ferramenta de "sele√ß√£o"
                selectElement(el);
                isDragging = true;
                const pt = getSVGPoint(e);
                
                const transform = el.transform.baseVal;
                // Consolida as transforma√ß√µes para obter uma √∫nica matriz
                const matrix = transform.consolidate()?.matrix || paintArea.createSVGMatrix();
                
                offset = {
                    x: pt.x - matrix.e,
                    y: pt.y - matrix.f,
                };
                el.style.cursor = "grabbing";
            }
        });

        paintArea.addEventListener("mousemove", (e) => {
            if (!isDragging) return;
            const pt = getSVGPoint(e);
            const newX = pt.x - offset.x;
            const newY = pt.y - offset.y;
            
            let currentTransform = el.getAttribute("transform") || "";
            let scalePart = currentTransform.match(/scale\([^)]+\)/)?.[0] || "";
            el.setAttribute("transform", `translate(${newX} ${newY}) ${scalePart}`);
        });

        const stopDragging = () => {
            if (isDragging) {
                isDragging = false;
                el.style.cursor = "grab";
            }
        };

        paintArea.addEventListener("mouseup", stopDragging);
        paintArea.addEventListener("mouseleave", stopDragging);
    }
  </script>
</body>
</html>
