<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jogo de Pintura - Musi Kids</title>
<style>
  /* Estilos gerais */
  @import url('https://fonts.googleapis.com/css2?family=Baloo&display=swap');
  html, body {
    margin: 0; padding: 0; height: 100%;
    background: linear-gradient(135deg, #f9ecd3 0%, #f4a261 100%);
    font-family: 'Baloo', cursive, Arial, sans-serif;
    user-select: none;
    overflow: hidden;
    display: flex; flex-direction: column;
  }
  #btn-back {
    position: fixed; top: 10px; left: 10px;
    background: #3B7994; color: white;
    border: none; border-radius: 20px;
    padding: 12px 20px;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 6px 15px rgba(0,0,0,0.4);
    z-index: 1000; user-select: none;
    transition: background-color 0.3s ease;
  }
  #btn-back:hover { background: #305f71; }

  /* Ferramentas laterais externas */
  #toolbar {
    position: fixed; top: 70px; left: 10px; width: 64px;
    background: rgba(59, 121, 148, 0.9);
    border-radius: 25px; padding: 10px 6px;
    display: flex; flex-direction: column; gap: 15px;
    align-items: center;
    z-index: 998; user-select: none;
  }
  .tool-btn {
    width: 48px; height: 48px; border-radius: 20px;
    border: none; background: #def3f3; color: #185359;
    font-size: 26px; cursor: pointer;
    display: flex; justify-content: center; align-items: center;
    box-shadow: 0 5px 12px rgba(24, 83, 62, 0.3);
    transition: background-color 0.3s ease;
  }
  .tool-btn.selected {
    background: #185359; color: white;
  }
  .tool-btn:hover {
    background: #a2c1c1; color: #173e3f;
  }
  #color-picker {
    margin-top: 10px;
    width: 44px; height: 44px;
    border-radius: 22px;
    border: none;
    cursor: pointer;
  }
  /* Escala para formas geom√©tricas */
  #scale-controls {
    margin-top: 10px;
    display: none; /* Escondido por padr√£o, aparece ao selecionar uma forma */
    flex-direction: column;
    gap: 6px;
  }
  .scale-btn {
    width: 42px; height: 28px;
    background: #185359;
    color: white; border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: 800;
    user-select: none;
  }
  .scale-btn:active {
    background: #0f3c3a;
  }

  /* Paletas direita de imagens e formas */
  #palette-container {
    position: fixed; top: 70px; right: 10px;
    width: 210px; max-height: calc(100vh - 90px); /* Ajustado para nova altura */
    background: #fdeed6cc;
    border-radius: 20px;
    box-shadow: 0 5px 18px rgba(168, 84, 14, 0.7);
    padding: 10px;
    overflow-y: auto;
    z-index: 997;
  }
  #palette-container h3 {
    color: #B45105;
    font-weight: 700;
    margin: 0 0 12px 0;
    text-align: center;
    user-select: none;
  }
  .palette-item, .palette-shape {
    width: 90%;
    margin: 6px auto;
    cursor: grab;
    border-radius: 14px;
    box-shadow: 0 4px 11px rgba(168, 84, 14, 0.6);
    user-select: none;
    display: block;
    background-color: white;
  }
   .palette-item {
    padding: 5px;
    box-sizing: border-box;
  }
  .palette-shape {
    height: 75px;
    border: 2px solid black;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .palette-shape.circle {
    border-radius: 100%;
  }
  .palette-shape.triangle {
    width: 0;
    height: 0;
    background-color: transparent;
    border-left: 38px solid transparent;
    border-right: 38px solid transparent;
    border-bottom: 68px solid black;
    margin-top: 8px;
    margin-bottom: 8px;
    border-top: none;
    border-radius: 0;
  }
  /* Pintura */
  #paint-area-container {
    margin-left: 80px;
    margin-right: 230px; /* Espa√ßo para a paleta da direita */
    /* CORRE√á√ÉO: Aumentado o espa√ßo no topo para n√£o cobrir o bot√£o */
    margin-top: 50px; 
    flex-grow: 1;
    overflow: auto;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative; 
  }
  #undo-redo-container {
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      z-index: 10;
      background: rgba(59, 121, 148, 0.9);
      padding: 8px 15px;
      border-radius: 25px;
  }
  #undo-redo-container button {
      background: #4ea6c1;
      border: none; border-radius: 20px;
      padding: 6px 16px;
      color: white;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      transition: background-color 0.3s ease;
      font-family: 'Baloo', cursive;
  }
  #undo-redo-container button:disabled {
      background: #97bccd;
      cursor: not-allowed;
  }
   #undo-redo-container button:not(:disabled):hover {
    background: #357d9b;
  }
  
  svg#paint-area {
    border-radius: 20px;
    border: 4px solid #185359;
    background: white;
    width: 95%;
    height: 95%;
    display: block;
    user-select: none;
  }

  /* Estilo para forma selecionada */
  .selected-shape {
      outline: 3px dashed #3B7994;
      outline-offset: 4px;
  }
</style>
</head>
<body>
  <button id="btn-back" aria-label="Menu de jogos" title="Voltar para Menu de Jogos">MENU DE JOGOS</button>

  <div id="toolbar" role="toolbar" aria-label="Ferramentas">
    <button class="tool-btn selected" id="tool-pencil" aria-pressed="true" aria-label="Selecionar l√°pis">‚úèÔ∏è</button>
    <button class="tool-btn" id="tool-eraser" aria-pressed="false" aria-label="Selecionar borracha">ü©π</button>
    <button class="tool-btn" id="tool-brush" aria-pressed="false" aria-label="Selecionar pincel">üñåÔ∏è</button>
    <button class="tool-btn" id="tool-bucket" aria-pressed="false" aria-label="Selecionar balde de tinta">üíß</button>
    
    <div id="scale-controls">
      <button class="scale-btn" id="scale-increase" aria-label="Aumentar tamanho">Ôºã</button>
      <button class="scale-btn" id="scale-decrease" aria-label="Diminuir tamanho">‚àí</button>
    </div>
    <input type="color" id="color-picker" aria-label="Escolher cor" value="#000000" />
  </div>

  <div id="palette-container" aria-label="Paletas de imagens e formas">
    <h3>Imagens para pintar</h3>
    
    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZD0iTTEyIDJsMy4wOSAxMy41OEwyMiAxMlY5bC03LjQyIDEuMzdMMTIgMloiLz48cGF0aCBkPSJNMjIgOWwtNy40MiAxLjM3TDEyIDE5bDIuNTgtNy42M0wyMiA5WiIvPjxwYXRoIGQ9Ik0xMiAyTCA1LjUgOS4zMUwyIDhsMTAgMTBMMjIgOGwtMy41IDUuNjNMMTIgMloiLz48L3N2Zz4=" class="palette-item" draggable="true" alt="Estrela para colorir" />
    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZD0iTTE5Ljg0IDEwLjE2Yy0uMTEgMC0uMjItLjAxLS4zMy0uMDMtMS4wNy0uMTktMi4wMS0uNTMtMi44My0uOTgtLjgyLS40Ni0xLjU0LTEuMDQtMi4xMS0xLjczLS41My0uNjQtLjktMS40Mi0xLjA3LTIuMjctLjE2LS44My0uMDgtMS42OS4xOS0yLjQ5LjI3LS44MS43NS0xLjU0IDEuMzctMi4xM0E1LjcgNS43IDAgMCAxIDE3LjM5IDBjMS41NSAwIDMuMDMuNTkgNC4xMyAxLjYzLjM4LjM1LjcxLjczIDEgMS4xMS44MSAxLjA3IDEuMjkgMi40IDEuNDUgMy44Mi4xNiAxLjQyLS4wMyAyLjg4LS41NyA0LjIyLS4xOC40NS0uMzguOS0uNjEgMS4zMy0uNDcuOS0xLjA4IDEuNzEtMS44MSAyLjM5YTcuMjQgNy4yNCAwIDAgMS0yLjQtMS41MXptLTQuNTUgNi44N2MtLjM0IDAtLjY4LS4wMi0xLjAyLS4wNmExMi45MiAxMi45MiAwIDAgMS0zLjU2LS44M2MtMS4yOS0uNDgtMi41My0xLjE0LTMuNjYtMS45NS0xLjEzLS44Mi0yLjE0LTEuOC0yLjk2LTIuODktLjgyLTEuMDgtMS40Ni0yLjI3LTEuODctMy41NmExMi40MyAxMi40MyAwIDAgMS0uNi00Ljc1Yy4xMS0uNjQuMy0xLjI4LjU0LTEuOEE4Ljg0IDguODQgMCAwIDEgMy42MyAyLjdjLjM1LS4zLjcyLS41NyAxLjEtLjc5LjM4LS4yMS43OC0uMzggMS4yLS40OUExLjQ0IDEuNDQgMCAwIDEgNyAxLjVjLjMyLjM2LjU0LjguNjUgMS4yOC4xMS40OC4xMyAxIC4wMiAxLjQ5LS4xMS40OS0uMzQuOTYtLjY0IDEuMzgtLjU1LjczLTEuMyAxLjM0LTIuMTMgMS43NmEzLjY4IDMuNjggMCAwIDAtMS4yNiAyLjgxYzAgLjkzLjI5IDEuODUuODIgMi42OC41My44NCAxLjIzIDEuNTkgMi4wNCAyLjE5LjgxLjYgMS43IDEuMDYgMi42MyAxLjM1YTkuMSA5LjEgMCAwIDAgMy4xNC4zOWMuNDkgMCAuOTgtLjA0IDEuNDYtLjEyem00LjU1LTYuODciLz48L3N2Zz4=" class="palette-item" draggable="true" alt="Cora√ß√£o para colorir" />
    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZD0iTTIxIDEzYy0uNTUgMC0xIC40NS0xIDF2NWgtMThWOGMwLS41NS0uNDUtMS0xLTFzLTEgLjQ1LTEgMXYxMGMwIC41NS40NSAxIDEgMWgxMGMuNTUgMCAxLS40NSAxLTF2LTloNmMuNTUgMCAxLS40NSAxLTFoLTJjLS41NSAwLTEtLjQ1LTEtMVptLTIuNSA5SDYuNWMtLjI4IDAtLjUtLjIyLS41LS41VjE0aDEyLjV2Ny41YzAgLjI4LS4yMi41LS41LjVabS04LjUtMTNoLTdjLS41NSAwLTEtLjQ1LTEtMXMuNDUtMSAxLTFoN2MuNTUgMCAxIC40NSAxIDFzLS40NSAxLTEgMVptMTAtNEg0Yy0uNTUgMC0xLS40NS0xLTFzLjQ1LTEgMS0xaDE0Yy41NSAwIDEgLjQ1IDEgMXMtLjQ1IDEtMSAxWiIvPjwvc3ZnPg==" class="palette-item" draggable="true" alt="Carro para colorir" />
    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZD0iTTUgMTJjMCAxLjQuNzYgMi42MyAyIDMuNWwzIDMuNUMxMS40NyAyMC40MyAxMy42NCAyMSAxNiAyMWM0LjQxIDAgOC0zLjU5IDgtOHMtMy41OS04LTgtOGMtMi4zNiAwLTQuNTMuOTctNi4wNSAyLjVMMTAgMTBoLTZWM2wzIDNjMS4yOC0xLjI4IDIuOTctMiA0LjgtMnM0LjE3LjczIDUuNzggMi4wMmMxLjYxIDEuMjkgMi43MiAzLjA5IDIuOTYgNS4wNGgzLjI2djJoLTMuMDJjLS4yNCAyLjE2LTEuNDYgNC4xLTMuMjIgNS41Ni0xLjc2IDEuNDYtMy45OCAyLjE5LTYuMjggMS45My0xLjk1LS4yMi0zLjc0LTEuMDktNS4xMS0yLjQ2bC0zLTMuNUMxLjczIDE0LjYxIDEgMTMuMzUgMSAxMmg0WiIvPjwvc3ZnPg==" class="palette-item" draggable="true" alt="Dinossauro para colorir" />
    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZD0iTTIyIDguNTh2MS45MWwtMi4xOS0uNDRhNy4zNSA3LjM1IDAgMCAxLTIuNjkgMS4zM0wxNiAxMy4yMlYxNWwtMS41Ni0uNDFhNi41MiA2LjUyIDAgMCAxLTIuMzYgMEwxMSA5LjQxIDcuNSAxMC41OSA1IDguNThWNi42N2wyLjE5LjQ0YTcuMzUgNy4zNSAwIDAgMSAyLjY5LTEuMzNMMTEgMy45N3YtMS44bDEuNTYuNDFhNi41MiA2LjUyIDAgMCAxIDIuMzYgMEwxOSAyLjU5bDMyLjQxIDMuNDFINjhsMi4xOSA3LjU5WiIvPjwvc3ZnPg==" class="palette-item" draggable="true" alt="Foguete para colorir" />

    <h3 style="margin-top: 20px;">Formas Geom√©tricas</h3>
    <div class="palette-shape circle" draggable="true" role="img" aria-label="C√≠rculo"></div>
    <div class="palette-shape square" draggable="true" role="img" aria-label="Quadrado"></div>
    <div class="palette-shape triangle" draggable="true" role="img" aria-label="Tri√¢ngulo"></div>
  </div>

  <div id="paint-area-container">
    <div id="undo-redo-container">
        <button id="undo-btn" disabled aria-label="Desfazer">‚Ü©Ô∏è Desfazer</button>
        <button id="redo-btn" disabled aria-label="Refazer">‚Ü™Ô∏è Refazer</button>
    </div>
    <svg id="paint-area" viewBox="0 0 800 600" role="img" aria-label="√Årea para pintar" tabindex="0">
       </svg>
  </div>

  <script>
    const paintArea = document.getElementById("paint-area");
    const svgNS = "http://www.w3.org/2000/svg";

    const btnBack = document.getElementById("btn-back");
    const tools = {
      pencil: document.getElementById("tool-pencil"),
      eraser: document.getElementById("tool-eraser"),
      brush: document.getElementById("tool-brush"),
      bucket: document.getElementById("tool-bucket"),
    };
    const scaleControls = document.getElementById("scale-controls");
    const scaleIncrease = document.getElementById("scale-increase");
    const scaleDecrease = document.getElementById("scale-decrease");

    const colorPicker = document.getElementById("color-picker");
    const undoBtn = document.getElementById("undo-btn");
    const redoBtn = document.getElementById("redo-btn");

    let currentTool = "pencil";
    let currentColor = colorPicker.value;
    let isDrawing = false;
    let currentPath = null;
    let pathData = "";

    let selectedElement = null; 
    let undoStack = [];
    let redoStack = [];

    // --- Fun√ß√µes de Sele√ß√£o e Escala ---
    function deselectAll() {
        if (selectedElement) {
            selectedElement.classList.remove("selected-shape");
            selectedElement = null;
        }
        scaleControls.style.display = "none";
    }

    function selectElement(el) {
        deselectAll();
        selectedElement = el;
        selectedElement.classList.add("selected-shape");
        scaleControls.style.display = "flex";
    }

    function scaleSelected(factor) {
        if (!selectedElement) return;

        const el = selectedElement;
        const oldTransform = el.getAttribute("transform") || "";
        let currentTransform = oldTransform;
        let scaleMatch = currentTransform.match(/scale\(([^)]+)\)/);
        let currentScale = scaleMatch ? parseFloat(scaleMatch[1]) : 1;
        
        let newScale = currentScale * factor;
        if (newScale < 0.1 || newScale > 10) return;

        let otherTransforms = currentTransform.replace(/scale\([^)]+\)/, '').trim();
        const newTransform = `${otherTransforms} scale(${newScale})`.trim();
        el.setAttribute("transform", newTransform);
        pushUndo({type: 'transform', element: el, oldTransform: oldTransform, newTransform: newTransform});
    }

    scaleIncrease.addEventListener("click", () => scaleSelected(1.1));
    scaleDecrease.addEventListener("click", () => scaleSelected(0.9));

    // --- Fun√ß√µes de Desfazer/Refazer (Undo/Redo) ---
    function updateUndoRedoButtons() {
      undoBtn.disabled = undoStack.length === 0;
      redoBtn.disabled = redoStack.length === 0;
    }

    function pushUndo(action) {
      undoStack.push(action);
      if (undoStack.length > 50) undoStack.shift();
      redoStack = [];
      updateUndoRedoButtons();
    }

    undoBtn.addEventListener("click", () => {
      if (undoStack.length === 0) return;
      const action = undoStack.pop();
      if (action.type === 'add') {
        paintArea.removeChild(action.element);
      } else if (action.type === 'fill') {
        action.element.setAttribute("fill", action.oldColor);
      } else if (action.type === 'transform') {
        action.element.setAttribute("transform", action.oldTransform);
      }
      redoStack.push(action);
      updateUndoRedoButtons();
    });

    redoBtn.addEventListener("click", () => {
      if (redoStack.length === 0) return;
      const action = redoStack.pop();
      if (action.type === 'add') {
        paintArea.appendChild(action.element);
      } else if (action.type === 'fill') {
        action.element.setAttribute("fill", action.newColor);
      } else if (action.type === 'transform') {
        action.element.setAttribute("transform", action.newTransform);
      }
      undoStack.push(action);
      updateUndoRedoButtons();
    });

    btnBack.onclick = () => { location.href = "../"; };

    // --- L√≥gica das Ferramentas ---
    function selectTool(tool) {
      currentTool = tool;
      for (const key in tools) {
        if (tools[key]) {
          tools[key].classList.toggle("selected", key === tool);
          tools[key].setAttribute("aria-pressed", key === tool ? "true" : "false");
        }
      }
      if (['pencil', 'eraser', 'brush', 'bucket'].includes(tool)) {
          deselectAll();
      }
    }

    for (const key in tools) {
      if (tools[key]) {
        tools[key].addEventListener("click", () => selectTool(key));
      }
    }
    selectTool("pencil");

    colorPicker.addEventListener("input", (e) => { currentColor = e.target.value; });
    
    // --- L√≥gica de Desenho e Balde de Tinta ---
    function getSVGPoint(e) {
        const pt = paintArea.createSVGPoint();
        pt.x = e.clientX;
        pt.y = e.clientY;
        return pt.matrixTransform(paintArea.getScreenCTM().inverse());
    }

    paintArea.addEventListener("mousedown", (e) => {
        if (e.target !== paintArea) return;
        deselectAll(); 
        if (['pencil', 'eraser', 'brush'].includes(currentTool)) {
            isDrawing = true;
            const pt = getSVGPoint(e);
            pathData = `M ${pt.x} ${pt.y}`;
            currentPath = document.createElementNS(svgNS, "path");
            currentPath.setAttribute("fill", "none");
            currentPath.setAttribute("stroke", currentTool === "eraser" ? "#fff" : currentColor);
            currentPath.setAttribute("stroke-width", currentTool === "brush" ? 12 : currentTool === "eraser" ? 20 : 3);
            currentPath.setAttribute("stroke-linejoin", "round");
            currentPath.setAttribute("stroke-linecap", "round");
            currentPath.setAttribute("d", pathData);
            paintArea.appendChild(currentPath);
        }
    });

    paintArea.addEventListener("mousemove", (e) => {
      if (!isDrawing || !currentPath) return;
      const pt = getSVGPoint(e);
      pathData += ` L ${pt.x} ${pt.y}`;
      currentPath.setAttribute("d", pathData);
    });
    
    const endDrawing = () => {
        if (isDrawing && currentPath) {
            // CORRE√á√ÉO: Fecha o caminho do desenho para que possa ser pintado
            pathData += " Z";
            currentPath.setAttribute("d", pathData);
            // Agora o desenho se torna uma forma fechada e pint√°vel
            currentPath.setAttribute("fill", "white"); // D√° um fundo branco para ser clic√°vel

            pushUndo({ type: 'add', element: currentPath });
            isDrawing = false;
            currentPath = null;
        }
    };

    paintArea.addEventListener("mouseup", endDrawing);
    paintArea.addEventListener("mouseleave", endDrawing);

    paintArea.addEventListener("click", (e) => {
        if (currentTool !== 'bucket') return;
        const target = e.target;
        if (['rect', 'circle', 'polygon', 'path'].includes(target.tagName.toLowerCase())) {
            const oldColor = target.getAttribute('fill') || 'white';
            if (oldColor.toLowerCase() === currentColor.toLowerCase()) return;

            target.setAttribute('fill', currentColor);
            pushUndo({ type: 'fill', element: target, oldColor: oldColor, newColor: currentColor });
        }
    });

    // --- L√≥gica de Arrastar e Soltar (Drag and Drop) ---
    document.querySelectorAll(".palette-item, .palette-shape").forEach((item) => {
      item.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("application/json", JSON.stringify({
            type: item.classList.contains("palette-item") ? "image" : "shape",
            src: item.src || null,
            shape: [...item.classList].find((c) => ["circle", "square", "triangle"].includes(c)),
        }));
      });
    });

    paintArea.addEventListener("dragover", (e) => e.preventDefault());

    paintArea.addEventListener("drop", (e) => {
        e.preventDefault();
        let data;
        try { data = JSON.parse(e.dataTransfer.getData("application/json")); } catch (err) { return; }

        const pt = getSVGPoint(e);
        let el;

        if (data.type === "image" && data.src) {
            el = document.createElementNS(svgNS, "image");
            el.setAttribute("href", data.src);
            el.setAttribute("x", pt.x - 75);
            el.setAttribute("y", pt.y - 75);
            el.setAttribute("width", 150);
            el.setAttribute("height", 150);
        } else if (data.type === "shape" && data.shape) {
            if (data.shape === "circle") {
                el = document.createElementNS(svgNS, "circle"); el.setAttribute("cx", pt.x); el.setAttribute("cy", pt.y); el.setAttribute("r", 50);
            } else if (data.shape === "square") {
                el = document.createElementNS(svgNS, "rect"); el.setAttribute("x", pt.x - 50); el.setAttribute("y", pt.y - 50); el.setAttribute("width", 100); el.setAttribute("height", 100); el.setAttribute("rx", 10);
            } else if (data.shape === "triangle") {
                el = document.createElementNS(svgNS, "polygon"); const size = 60; el.setAttribute("points", `${pt.x},${pt.y - size} ${pt.x - size},${pt.y + size} ${pt.x + size},${pt.y + size}`);
            }
            if(el) { el.setAttribute("fill", "white"); el.setAttribute("stroke", "black"); el.setAttribute("stroke-width", 3); }
        }
        
        if (el) {
            el.style.cursor = "grab";
            paintArea.appendChild(el);
            pushUndo({ type: 'add', element: el });
            makeDraggableAndSelectable(el);
            selectElement(el); // Seleciona o novo elemento automaticamente
        }
    });

    function makeDraggableAndSelectable(el) {
        let isDragging = false;
        let offset;
        let startTransform;

        el.addEventListener("mousedown", (e) => {
            e.stopPropagation();
            // CORRE√á√ÉO: Permite selecionar a forma com qualquer ferramenta
            selectElement(el);
            
            // Mas s√≥ permite arrastar com as ferramentas certas (l√°pis ou pincel)
            if (['pencil', 'brush'].includes(currentTool)) {
                isDragging = true;
                const pt = getSVGPoint(e);
                startTransform = el.getAttribute("transform") || "";
                const matrix = el.transform.baseVal.consolidate()?.matrix || paintArea.createSVGMatrix();
                offset = { x: pt.x - matrix.e, y: pt.y - matrix.f };
                el.style.cursor = "grabbing";
            }
        });

        paintArea.addEventListener("mousemove", (e) => {
            if (!isDragging) return;
            const pt = getSVGPoint(e);
            const newX = pt.x - offset.x;
            const newY = pt.y - offset.y;
            let currentTransform = el.getAttribute("transform") || "";
            let scalePart = currentTransform.match(/scale\([^)]+\)/)?.[0] || "";
            el.setAttribute("transform", `translate(${newX} ${newY}) ${scalePart}`);
        });

        const stopDragging = () => {
            if (isDragging) {
                isDragging = false;
                el.style.cursor = "grab";
                const newTransform = el.getAttribute("transform") || "";
                if (newTransform !== startTransform) {
                    pushUndo({ type: 'transform', element: el, oldTransform: startTransform, newTransform: newTransform });
                }
            }
        };
        paintArea.addEventListener("mouseup", stopDragging);
        paintArea.addEventListener("mouseleave", stopDragging);
    }
  </script>
</body>
</html>
