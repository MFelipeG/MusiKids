<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Letrinhas - MusiKids Fun</title>
<style>
  /* ... (igual ao seu código original, mantido para economia de espaço) ... */
</style>
</head>
<body>
  <header>Letrinhas - MusiKids Fun</header>
  <button id="btn-menu" onclick="window.location.href='../'">MENU DE JOGOS</button>
  <div id="main-container">
    <div id="categoria-container">
      <select id="categoria-escolha" aria-label="Seleção de categoria">
        <option value="animais">Animais</option>
        <option value="objetos">Objetos</option>
        <option value="frutas">Frutas</option>
        <option value="nomes">Nomes</option>
      </select>
    </div>
    <div id="area-add">
      <input type="text" id="add-palavra" maxlength="15" placeholder="Digite palavra" aria-label="Adicionar palavra"/>
      <button id="btn-add">Adicionar</button>
    </div>
    <div id="instrucao">Arraste as letras para formar a palavra!</div>
    <div id="palavra-atual"></div>
    <div id="caixa-letras"></div>
    <div id="slots-palavra"></div>
    <button id="next-btn">Próxima Palavra</button>
    <button id="reset-btn">Refazer</button>
    <div id="resultado"></div>
    <div id="confetti"></div>
  </div>
<script>
  const categorias = {
    animais: ["GATO","CACHORRO","PATO","VACA","PERU","RATO","ANJO","ABELHA","ELEFANTE","RAPOSA","COELHO","PEIXE","TOURO","URSO","GORILA","LAGARTO","MACACO","GALINHA","CAVALO","POMBO","TIGRE","PAPAGAIO","GALINHA","LEAO","PORCO","CAVALO","ONÇA","FURAO","URSO","TAPIR","MINHOCA","GIRAFINHA","LCEO","HIPOPOTAMO","CAVALO","TUCANO"],
    objetos: ["BOLA","MESA","CAIXA","CAMISA","SITE","CHALE","JABUTI","MESA","PORTA","TELA","LIVRO","CANETA","FITA","SOL","TESOURA","ARMARIO","LANÇA","PENELOPE","BOLSA","CPU","BOTELHO","BICICLETA","GORO","ESTCAO","PORTICO","MARIA","CAIXA","TELEFONE"],
    frutas: ["MANGA","LARANJA","UVA","BANANA","ABACATE","MARACUJA","GOIABA","AMORA","MORANGOS","MELAO","JAMBALAIA","JOCOTI","GUAVA","JABUTIBA","LENHA","CEARA","ELMIRAM", "AVAI", "ANEA", "RIA"],
    nomes: ["ANA","LUIZ","MARIA","PEDRO","JOAO","CARLOS","FERNANDO","AMANDA","PATRICIA","HELENA","BRUNO","JESSE","LUCAS","FABIO","MARCIO","MONICA","IGOR","ARTHUR"]
  };

  let categoriaAtual = 'animais';
  let palavras = [];
  let indice = 0;
  let letrasRestantes = [];
  let slots = [];
  let draggingIdx = null;
  let palavrasAdicionadas = [];

  function shuffle(array) {
    let arr = array.slice();
    for(let i = arr.length -1; i > 0; i--){
      let j = Math.floor(Math.random() * (i +1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
  function shuffleWord(word) {
    return word.split('').sort(() => Math.random() - 0.5);
  }
  function showWord() {
    let palavra = palavras[indice];
    document.getElementById('palavra-atual').innerText = palavra;
    buildSlots(palavra);
    buildLetters(palavra);
    document.getElementById('resultado').innerText = '';
    document.getElementById('next-btn').style.display = 'none';
    document.getElementById('reset-btn').style.display = 'inline';
  }
  function buildSlots(palavra) {
    let container = document.getElementById('slots-palavra');
    container.innerHTML = '';
    slots = [];
    for(let i=0; i<palavra.length; i++) {
      let slot = document.createElement('div');
      slot.className = 'slot-letra';
      slot.dataset.index = i;
      // Eventos para mouse
      slot.addEventListener('dragover', e=> {
        e.preventDefault();
        slot.classList.add('over');
      });
      slot.addEventListener('dragleave', e=> {
        slot.classList.remove('over');
      });
      slot.addEventListener('drop', e=> {
        e.preventDefault();
        slot.classList.remove('over');
        if(slot.innerText === '') {
          let letra = letrasRestantes[draggingIdx];
          slot.innerText = letra;
          letrasRestantes.splice(draggingIdx, 1); // <- CORRIGIDO!
          updateLetters();
          checkResult();
        }
      });
      slot.addEventListener('touchstart', e => {
        e.preventDefault();
      });
      slot.addEventListener('touchmove', e => {
        e.preventDefault();
      });
      slot.addEventListener('touchend', e => {
        e.preventDefault();
        const touch = e.changedTouches[0];
        const target = document.elementFromPoint(touch.clientX, touch.clientY);
        if (target && target.classList.contains('slot-letra') && target.innerText === '') {
          let letra = letrasRestantes[draggingIdx];
          target.innerText = letra;
          letrasRestantes.splice(draggingIdx, 1); // <- CORRIGIDO!
          updateLetters();
          checkResult();
        }
      });
      slot.addEventListener('click', ()=> {
        if(slot.innerText !== '') {
          letrasRestantes.push(slot.innerText);
          slot.innerText = '';
          updateLetters();
          checkResult();
        }
      });
      slot.addEventListener('touchend', (e) => {
        e.preventDefault();
        if (e.target.innerText !== '') {
          letrasRestantes.push(e.target.innerText);
          e.target.innerText = '';
          updateLetters();
          checkResult();
        }
      });
      slots.push(slot);
      container.appendChild(slot);
    }
  }
  function buildLetters(palavra) {
    letrasRestantes = shuffleWord(palavra);
    updateLetters();
  }
  function updateLetters() {
    let container = document.getElementById('caixa-letras');
    container.innerHTML = '';
    letrasRestantes.forEach((letra, idx) => {
      if(letra !== null && letra !== undefined) {
        let letterDiv = document.createElement('div');
        letterDiv.className = 'letra-drag';
        letterDiv.innerText = letra;
        letterDiv.draggable = true;
        letterDiv.addEventListener('dragstart', () => {
          draggingIdx = idx;
          letterDiv.classList.add('dragging');
        });
        letterDiv.addEventListener('dragend', () => {
          letterDiv.classList.remove('dragging');
          draggingIdx = null;
        });
        letterDiv.addEventListener('touchstart', (e) => {
          e.preventDefault();
          draggingIdx = idx;
          letterDiv.classList.add('dragging');
        });
        letterDiv.addEventListener('touchmove', (e) => {
          e.preventDefault();
        });
        letterDiv.addEventListener('touchend', (e) => {
          letterDiv.classList.remove('dragging');
          const touch = e.changedTouches[0];
          const target = document.elementFromPoint(touch.clientX, touch.clientY);
          if (target && target.classList.contains('slot-letra') && target.innerText === '') {
            let letra = letrasRestantes[draggingIdx];
            target.innerText = letra;
            letrasRestantes.splice(draggingIdx, 1); // <- CORRIGIDO!
            updateLetters();
            checkResult();
          }
          draggingIdx = null;
        });
        container.appendChild(letterDiv);
      }
    });
  }
  function checkResult() {
    if(slots.every(slot=>slot.innerText !== '')) {
      let result = true;
      for(let i=0; i<slots.length; i++) {
        if(slots[i].innerText !== palavras[indice][i]) {
          result = false;
          break;
        }
      }
      let resMsg = document.getElementById('resultado');
      let btnNext = document.getElementById('next-btn');
      let btnReset = document.getElementById('reset-btn');
      if(result) {
        resMsg.innerText = 'Parabéns! Você acertou!';
        btnNext.style.display = 'inline-block';
        btnReset.style.display = 'none';
        confetti();
      } else {
        resMsg.innerText = 'Tente novamente!';
        btnNext.style.display = 'none';
        btnReset.style.display = 'inline-block';
      }
    } else {
      let resMsg = document.getElementById('resultado');
      let btnNext = document.getElementById('next-btn');
      let btnReset = document.getElementById('reset-btn');
      resMsg.innerText = '';
      btnNext.style.display = 'none';
      btnReset.style.display = 'inline-block';
    }
  }
  document.getElementById('next-btn').onclick = () => {
    indice++;
    if(indice >= palavras.length) indice = 0;
    showWord();
  };
  document.getElementById('reset-btn').onclick = () => {
    buildLetters(palavras[indice]);
    slots.forEach(s => s.innerText = '');
    document.getElementById('resultado').innerText = '';
  };
  document.getElementById('categoria-escolha').onchange = function(e) {
    categoriaAtual = e.target.value;
    palavras = shuffle(categorias[categoriaAtual]);
    indice = 0;
    showWord();
  };
  document.getElementById('btn-add').onclick = function() {
    let input = document.getElementById('add-palavra');
    let nova = input.value.trim().toUpperCase();
    if(nova.length >= 2 && /^[A-ZÇÁÉÍÓÚ]+$/.test(nova)) {
      categorias[categoriaAtual].unshift(nova);
      palavras = categorias[categoriaAtual].slice();
      indice = 0;
      showWord();
      input.value = '';
    } else {
      input.style.animation = 'shake 0.3s';
      setTimeout(() => input.style.animation = '', 300);
      input.focus();
    }
  };
  function confetti() {
    let container = document.getElementById('confetti');
    container.innerHTML = '';
    let colors = ['#ff3980','#ff98a2','#fff89a','#a2e87e','#7de8a1'];
    for(let i=0; i<100; i++) {
      let conf = document.createElement('div');
      conf.className = 'confetti-piece';
      conf.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
      conf.style.top = (window.innerHeight*Math.random()) + 'px';
      conf.style.left = (window.innerWidth*Math.random()) + 'px';
      conf.style.width = '7px';
      conf.style.height = '7px';
      conf.style.position = 'absolute';
      conf.style.borderRadius = '50%';
      conf.style.opacity = '1';
      conf.style.zIndex = 9999;
      conf.style.animation = `fall 3s linear forwards`;
      conf.style.animationDelay = (i*0.03) + 's';
      container.appendChild(conf);
    }
    setTimeout(() => {container.innerHTML = '';}, 3000);
  }
  const style = document.createElement('style');
  style.innerHTML = `
    @keyframes fall {
      0% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(100vh); opacity: 0; }
    }
    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(5px); }
      50% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
      100% { transform: translateX(0); }
    }
  `;
  document.head.appendChild(style);
  palavras = shuffle(categorias[categoriaAtual]);
  showWord();
</script>
</body>
</html>
