<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Jogo do Labirinto - MusiKids Fun</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700;800&display=swap');

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Baloo 2', Arial, cursive, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden; /* Garante que nada escape da tela */
      position: relative;
    }

    /* --- PLAYER PADR√ÉO MUSIKIDS --- */
    #musikids-player-card {
      background: white; padding: 6px 15px; display: flex; align-items: center; gap: 10px;
      border: 3px solid #FF77A9; border-radius: 50px; position: fixed; top: 10px; right: 10px; 
      z-index: 10001; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    .player-controls { display: flex; gap: 6px; align-items: center; }
    .player-btn {
      background: #FF77A9; border: none; color: white; width: 30px; height: 30px; 
      border-radius: 50%; cursor: pointer; display: flex; align-items: center; 
      justify-content: center; font-size: 12px;
    }
    .player-label { font-weight: 800; color: #FF4C8B; font-size: 0.8rem; }
    .btn-shuffle.active { background: #21a7ff !important; }

    /* Bot√£o Menu */
    #menuButton {
      position: fixed; top: 10px; left: 10px; z-index: 1000;
      padding: 8px 15px; font-size: 0.9rem; border-radius: 9px; border: none;
      background: linear-gradient(135deg, #ff007f, #21a7ff 110%);
      color: #fff; font-weight: bold; cursor: pointer;
    }

    #scoreBoard {
      position: fixed; top: 50px; left: 10px;
      padding: 5px 12px; font-size: 12px; font-weight: 700; border-radius: 8px;
      background: rgba(255, 255, 255, 0.2); color: white; backdrop-filter: blur(5px);
      z-index: 1000;
    }

    .game-wrapper { 
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      width: 100%; max-height: 95vh; padding: 10px;
    }

    h1 { color: white; font-size: 1.8rem; margin-bottom: 2px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
    #levelInfo { color: rgba(255,255,255,0.9); font-size: 0.9rem; margin-bottom: 5px; }

    #gameCanvas {
      display: block; background: white; border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      max-width: 85vw; 
      max-height: 45vh; /* Ajuste crucial para n√£o empurrar os bot√µes */
      object-fit: contain;
      touch-action: none;
    }

    #message { margin-top: 5px; font-size: 1.1rem; font-weight: bold; color: #fff; min-height: 25px; }

    .controls { margin-top: 10px; display: flex; flex-direction: column; align-items: center; gap: 5px; }
    .control-row { display: flex; gap: 8px; justify-content: center; }
    .control-btn {
      width: 50px; height: 50px; font-size: 20px; border: none; border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; cursor: pointer; font-weight: bold;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }
    .control-btn:active { transform: scale(0.9); }

    #restartBtn {
      margin-top: 5px; padding: 8px 20px; font-size: 13px; font-weight: 700; border: none;
      border-radius: 50px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      color: white; cursor: pointer;
    }

    #confettiCanvas { pointer-events: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999; }

    @media (max-width: 600px) {
      #musikids-player-card { top: auto; bottom: 10px; right: 10px; scale: 0.85; }
      h1 { font-size: 1.4rem; }
      .control-btn { width: 45px; height: 45px; }
      #gameCanvas { max-height: 40vh; }
    }
  </style>
</head>
<body>

  <div id="musikids-player-card">
      <span class="player-label">M√∫sica</span>
      <div class="player-controls">
          <button class="player-btn" onclick="playPrev()">‚èÆÔ∏è</button>
          <button class="player-btn" onclick="toggleMusic()" id="play-pause-btn">‚ñ∂Ô∏è</button>
          <button class="player-btn" onclick="playNext()">‚è≠Ô∏è</button>
          <button class="player-btn btn-shuffle" onclick="toggleShuffle()" id="shuffle-btn">üîÄ</button>
      </div>
  </div>
  <div style="position: absolute; left: -9999px;"><div id="yt-audio-element"></div></div>

  <button id="menuButton" onclick="window.location.href='../index.html'">‚Üê Menu</button>
  <div id="scoreBoard">üèÜ: <span id="winsCount">0</span></div>

  <div class="game-wrapper">
    <h1>üê≠ Labirinto üßÄ</h1>
    <p id="levelInfo">N√≠vel: <span id="currentLevel">1</span></p>
    
    <canvas id="gameCanvas"></canvas>
    
    <p id="message"></p>
    
    <div class="controls">
      <div class="control-row">
        <button class="control-btn" onclick="movePlayer(0,-1)">‚Üë</button>
      </div>
      <div class="control-row">
        <button class="control-btn" onclick="movePlayer(-1,0)">‚Üê</button>
        <button class="control-btn" onclick="movePlayer(0,1)">‚Üì</button>
        <button class="control-btn" onclick="movePlayer(1,0)">‚Üí</button>
      </div>
      <button id="restartBtn" onclick="resetPosition()">üîÑ Recome√ßar</button>
    </div>
  </div>

  <canvas id="confettiCanvas"></canvas>

  <script src="../../js/musicas_data.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    // L√≥gica do Player (YouTube)
    let playerYT;
    let currentIndex = parseInt(sessionStorage.getItem('musi_index')) || 0;
    let isShuffle = sessionStorage.getItem('musi_shuffle') === 'true';

    function onYouTubeIframeAPIReady() {
        playerYT = new YT.Player('yt-audio-element', {
            height: '0', width: '0',
            videoId: listaMusicasIds[currentIndex],
            playerVars: { 'autoplay': sessionStorage.getItem('musi_playing') === 'true' ? 1 : 0 },
            events: {
                'onReady': (e) => {
                    const savedTime = parseFloat(sessionStorage.getItem('musi_time')) || 0;
                    if(savedTime > 0) e.target.seekTo(savedTime, true);
                    if(isShuffle) document.getElementById('shuffle-btn').classList.add('active');
                    updatePlayBtn();
                },
                'onStateChange': (e) => { if(e.data === 0) playNext(); updatePlayBtn(); }
            }
        });
    }

    function updatePlayBtn() { 
        const btn = document.getElementById('play-pause-btn'); 
        if(btn && playerYT && playerYT.getPlayerState) {
            btn.innerText = playerYT.getPlayerState() === 1 ? "‚è∏Ô∏è" : "‚ñ∂Ô∏è";
        }
    }

    function toggleMusic() { 
        playerYT.getPlayerState() === 1 ? playerYT.pauseVideo() : playerYT.playVideo(); 
        setTimeout(updatePlayBtn, 200); 
    }

    function playNext() { 
        currentIndex = isShuffle ? Math.floor(Math.random() * listaMusicasIds.length) : (currentIndex + 1) % listaMusicasIds.length; 
        playerYT.loadVideoById(listaMusicasIds[currentIndex]); 
        sessionStorage.setItem('musi_index', currentIndex); 
    }

    function playPrev() { 
        currentIndex = (currentIndex - 1 + listaMusicasIds.length) % listaMusicasIds.length; 
        playerYT.loadVideoById(listaMusicasIds[currentIndex]); 
        sessionStorage.setItem('musi_index', currentIndex); 
    }

    function toggleShuffle() { 
        isShuffle = !isShuffle; 
        sessionStorage.setItem('musi_shuffle', isShuffle); 
        document.getElementById('shuffle-btn').classList.toggle('active'); 
    }

    // L√≥gica do Labirinto
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const isMobile = window.innerWidth <= 600;
    const cellSize = isMobile ? 30 : 40;
    const mazeWidth = isMobile ? 9 : 11;
    const mazeHeight = 11;    
    canvas.width = mazeWidth * cellSize;
    canvas.height = mazeHeight * cellSize;

    let player = { x: 1, y: 1 };
    let cheese = { x: mazeWidth - 2, y: mazeHeight - 2 };
    let gameWon = false;
    let wins = 0;
    let currentLevel = 1;
    let currentMaze = null;

    const mazes = [
      [[1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,1,0,0,0,0,0,1],[1,0,1,0,1,0,1,1,1,0,1],[1,0,1,0,0,0,0,0,1,0,1],[1,0,1,1,1,1,1,0,1,0,1],[1,0,0,0,0,0,1,0,0,0,1],[1,1,1,0,1,0,1,1,1,0,1],[1,0,0,0,1,0,0,0,1,0,1],[1,0,1,1,1,1,1,0,1,0,1],[1,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1]],
      [[1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,1,0,1],[1,0,1,1,1,1,1,0,1,0,1],[1,0,1,0,0,0,0,0,0,0,1],[1,0,1,0,1,1,1,1,1,0,1],[1,0,0,0,1,0,0,0,1,0,1],[1,1,1,0,1,0,1,0,1,0,1],[1,0,0,0,0,0,1,0,0,0,1],[1,0,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1]]
    ];

    const mazesMobile = [
      [[1,1,1,1,1,1,1,1,1],[1,0,0,0,1,0,0,0,1],[1,0,1,0,1,0,1,0,1],[1,0,1,0,0,0,1,0,1],[1,0,1,1,1,0,1,0,1],[1,0,0,0,1,0,0,0,1],[1,1,1,0,1,1,1,0,1],[1,0,0,0,0,0,0,0,1],[1,0,1,1,1,1,1,0,1],[1,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1]],
      [[1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,1,0,1],[1,0,1,1,1,0,1,0,1],[1,0,0,0,1,0,0,0,1],[1,1,1,0,1,1,1,0,1],[1,0,0,0,0,0,1,0,1],[1,0,1,1,1,0,1,0,1],[1,0,1,0,0,0,0,0,1],[1,0,1,0,1,1,1,1,1],[1,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1]]
    ];

    function getRandomMaze() {
      const coll = isMobile ? mazesMobile : mazes;
      return coll[Math.floor(Math.random() * coll.length)];
    }

    function render() {
      ctx.clearRect(0,0, canvas.width, canvas.height);
      const wallColors = ['#4a5568', '#2c5282', '#744210', '#553c9a', '#9f1239'];
      ctx.fillStyle = wallColors[(currentLevel - 1) % wallColors.length];
      for(let y=0; y<currentMaze.length; y++) {
        for(let x=0; x<currentMaze[y].length; x++) {
          if(currentMaze[y][x] === 1) ctx.fillRect(x*cellSize, y*cellSize, cellSize, cellSize);
        }
      }
      ctx.font = `${cellSize-8}px Arial`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText('üßÄ', cheese.x*cellSize+cellSize/2, cheese.y*cellSize+cellSize/2);
      ctx.fillText('üê≠', player.x*cellSize+cellSize/2, player.y*cellSize+cellSize/2);
    }

    function movePlayer(dx, dy) {
      if(gameWon) return;
      let nx = player.x + dx, ny = player.y + dy;
      if(currentMaze[ny] && currentMaze[ny][nx] === 0) {
        player.x = nx; player.y = ny;
        if(player.x === cheese.x && player.y === cheese.y) {
          gameWon = true; wins++; document.getElementById('winsCount').textContent = wins;
          document.getElementById('message').textContent = 'üéâ CONSEGUIU! üéâ';
          setTimeout(startNewGame, 1500);
        }
        render();
      }
    }

    function resetPosition() { player = { x: 1, y: 1 }; render(); }
    function startNewGame() {
      currentMaze = getRandomMaze(); player = { x: 1, y: 1 };
      gameWon = false; currentLevel++; document.getElementById('currentLevel').textContent = currentLevel;
      document.getElementById('message').textContent = ''; render();
    }

    document.addEventListener('keydown', (e) => {
      if(e.key === "ArrowUp") movePlayer(0,-1);
      if(e.key === "ArrowDown") movePlayer(0,1);
      if(e.key === "ArrowLeft") movePlayer(-1,0);
      if(e.key === "ArrowRight") movePlayer(1,0);
    });

    currentMaze = getRandomMaze();
    render();
  </script>
</body>
</html>
