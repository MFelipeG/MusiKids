<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Quebra-CabeÃ§a - MusiKids Fun</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700;800&display=swap');
  
  body {
    margin: 0;
    padding: 1.5rem 0 .3rem 0;
    background: linear-gradient(135deg, #a0eaff 0%, #ffbad2 100%);
    font-family: 'Baloo 2', cursive, Arial, sans-serif;
    color: #333;
    min-height: 100vh;
    user-select: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    overflow-x: hidden;
  }

  /* --- PLAYER PADRÃƒO MARAVILHOSO --- */
  #musikids-player-card {
    background: white; 
    padding: 8px 18px; 
    display: flex; 
    align-items: center; 
    gap: 12px;
    border: 4px solid #FF77A9; 
    border-radius: 50px;
    position: fixed; 
    top: 15px; 
    right: 15px; 
    z-index: 10001;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  }
  .player-controls { display: flex; gap: 8px; align-items: center; }
  .player-btn {
    background: #FF77A9; 
    border: none; 
    color: white;
    width: 35px; 
    height: 35px; 
    border-radius: 50%; 
    cursor: pointer;
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-size: 14px;
    transition: transform 0.2s;
  }
  .player-btn:active { transform: scale(0.9); }
  .player-label { font-weight: 800; color: #FF4C8B; font-size: 0.9rem; margin-right: 2px; }
  .btn-shuffle.active { background: #21a7ff !important; }

  /* --- ESTILO DO JOGO --- */
  #voltar-menu-btn {
    position: fixed; top: 12px; left: 12px; z-index: 1000;
    padding: 10px 20px; font-size: 1.1rem; border-radius: 9px; border: none;
    background: linear-gradient(135deg, #ff007f, #21a7ff 110%);
    color: #fff; font-family: 'Baloo 2', cursive; font-weight: bold;
    box-shadow: 1px 3px 15px #21a7ff99; cursor: pointer; text-decoration: none;
  }

  header { font-weight: 900; font-size: 2.1rem; margin: 60px 0 1.5rem 0; color: #ff4c8b; text-shadow: 0 2px 8px #ffe1ee; }

  #config {
    width: 320px; background: #fff1f9; border-radius: 18px;
    padding: 1.3rem 1.6rem; box-shadow: 0 6px 30px #ffcce1a0; margin-bottom: 2rem;
  }

  label { font-weight: 700; display: block; margin-bottom: 0.5rem; color: #d23065; }

  select {
    width: 100%; padding: 0.5rem; font-size: 1rem; border-radius: 12px;
    border: 2px solid #ff2d7f; margin-bottom: 12px; font-family: 'Baloo 2';
    background: white; cursor: pointer;
  }

  #start-btn {
    width: 100%; padding: 1rem; font-weight: 700; border-radius: 20px; border: none;
    background-color: #ff4c8b; color: white; font-size: 1.25rem; cursor: pointer;
    box-shadow: 0 10px 20px #ffadc3b0; transition: transform 0.2s;
  }
  #start-btn:active { transform: scale(0.95); }

  #puzzle-container {
    display: none; width: 90vw; max-width: 500px; background: #fff0f7;
    border-radius: 20px; padding: 1rem; box-shadow: 0 8px 38px #ffa4c5cc; margin-bottom: 2rem;
  }

  #puzzle { display: grid; gap: 2px; background: #ffbad2cc; border-radius: 20px; overflow: hidden; width: 100%; }

  .piece {
    cursor: grab; border-radius: 10px; box-shadow: 0 4px 10px rgba(255,112,160,0.4);
    background-repeat: no-repeat; background-size: 100% 100%;
  }
  .piece:active { cursor: grabbing; }

  #instructions { font-weight: 700; margin-bottom: 12px; color: #d23065; min-height: 1.5em; }

  @media (max-width: 700px) {
    #musikids-player-card { top: auto; bottom: 15px; right: 10px; scale: 0.85; }
    header { margin-top: 80px; font-size: 1.6rem; }
    #config { width: 90vw; }
  }
</style>
</head>
<body>

<div id="musikids-player-card">
    <span class="player-label">MÃºsica</span>
    <div class="player-controls">
        <button class="player-btn" onclick="playPrev()">â®ï¸</button>
        <button class="player-btn" onclick="toggleMusic()" id="play-pause-btn">â–¶ï¸</button>
        <button class="player-btn" onclick="playNext()">â­ï¸</button>
        <button class="player-btn btn-shuffle" onclick="toggleShuffle()" id="shuffle-btn">ğŸ”€</button>
    </div>
</div>
<div style="position: absolute; left: -9999px;"><div id="yt-audio-element"></div></div>

<a href="../index.html" class="btn" id="voltar-menu-btn">â† Menu</a>
<header>Quebra-CabeÃ§a</header>

<div id="config">
  <label for="pieces-select">NÃ­vel (peÃ§as):</label>
  <select id="pieces-select">
    <option value="4" selected>Muito FÃ¡cil (2x2)</option>
    <option value="6">FÃ¡cil (3x2)</option>
    <option value="9">MÃ©dio (3x3)</option>
    <option value="15">DifÃ­cil (5x3)</option>
  </select>

  <label for="image-select">Selecione a imagem:</label>
  <select id="image-select">
    <option value="https://i.imgur.com/koHNUpP.jpeg">Logo MusiKids ğŸµ</option>
    <option value="https://i.imgur.com/Bsjz43J.jpeg">Meu Amorzinho â¤ï¸</option>
    <option value="https://i.imgur.com/l9ovoXM.jpeg">Animais ğŸ¦ğŸ¯ğŸ¦’</option>
    <option value="https://i.imgur.com/jIqPKoT.jpeg">Passarinho ğŸ¦</option>
    <option value="https://i.imgur.com/KT8ikZ4.jpeg">Gatinho ğŸ±</option>
    <option value="https://i.imgur.com/QECa0xX.jpeg">Girafa ğŸ¦’</option>
    <option value="https://i.imgur.com/7L4usk5.png">MÃ£e e Filha ğŸ‘©â€ğŸ‘§</option>
    <option value="https://i.imgur.com/Hu94nWs.jpeg">Menina e Formiga ğŸ‘§ğŸœ</option>
    <option value="https://i.imgur.com/bBbs67d.jpeg">O Sapinho ğŸ¸</option>
    <option value="https://i.imgur.com/VPzQDtb.jpeg">Ursinho Feliz ğŸ§¸</option>
    <option value="https://i.imgur.com/yZXzPEA.jpeg">RobÃ´ Amiguinho ğŸ¤–</option>
    <option value="https://i.imgur.com/HdDBc9e.jpeg">Dinossauro ğŸ¦–</option>
    <option value="https://i.imgur.com/CHKJoh4.jpeg">Trenzinho Azul ğŸš‚</option>
    <option value="https://i.imgur.com/uumcHtI.jpeg">Trenzinho Colorido ğŸš†</option>
    <option value="https://i.imgur.com/MuDcinl.jpeg">Astronauta MusiKids ğŸš€</option>
    <option value="https://i.imgur.com/GeQBMAh.jpeg">BalÃ£o MÃ¡gico ğŸˆ</option>
    <option value="https://i.imgur.com/CTsNa9E.jpeg">Coelhinho da PÃ¡scoa ğŸ°</option>
    <option value="https://i.imgur.com/PfHgOMe.jpeg">Ursinho Carinhoso ğŸ§¸ğŸ’–</option>
    <option value="https://i.imgur.com/ksaXISB.jpeg">Ursinho BrincalhÃ£o ğŸ§¸ğŸ‰</option>
    <option value="https://i.imgur.com/ASmGG1a.jpeg">Ursinho Dorminhoco ğŸ§¸ğŸŒ™</option>
  </select>
  <button id="start-btn">Iniciar Quebra-CabeÃ§a</button>
</div>

<div id="puzzle-container">
  <div id="instructions"></div>
  <div id="puzzle"></div>
</div>

<script src="../../js/musicas_data.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<script>
    let player;
    let currentIndex = parseInt(sessionStorage.getItem('musi_index')) || 0;
    let isShuffle = sessionStorage.getItem('musi_shuffle') === 'true';

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('yt-audio-element', {
            height: '0', width: '0',
            videoId: listaMusicasIds[currentIndex],
            playerVars: { 'autoplay': sessionStorage.getItem('musi_playing') === 'true' ? 1 : 0 },
            events: {
                'onReady': (e) => {
                    const savedTime = parseFloat(sessionStorage.getItem('musi_time')) || 0;
                    if(savedTime > 0) e.target.seekTo(savedTime, true);
                    if(isShuffle) document.getElementById('shuffle-btn').classList.add('active');
                    updatePlayBtn();
                },
                'onStateChange': (e) => {
                    if(e.data === 0) playNext();
                    updatePlayBtn();
                }
            }
        });
    }

    function updatePlayBtn() {
        const btn = document.getElementById('play-pause-btn');
        if(!btn || !player || !player.getPlayerState) return;
        const isPlaying = player.getPlayerState() === 1;
        btn.innerText = isPlaying ? "â¸ï¸" : "â–¶ï¸";
        sessionStorage.setItem('musi_playing', isPlaying);
    }

    function toggleMusic() {
        player.getPlayerState() === 1 ? player.pauseVideo() : player.playVideo();
        setTimeout(updatePlayBtn, 200);
    }

    function playNext() {
        currentIndex = isShuffle ? Math.floor(Math.random() * listaMusicasIds.length) : (currentIndex + 1) % listaMusicasIds.length;
        player.loadVideoById(listaMusicasIds[currentIndex]);
        sessionStorage.setItem('musi_index', currentIndex);
    }

    function playPrev() {
        currentIndex = (currentIndex - 1 + listaMusicasIds.length) % listaMusicasIds.length;
        player.loadVideoById(listaMusicasIds[currentIndex]);
        sessionStorage.setItem('musi_index', currentIndex);
    }

    function toggleShuffle() {
        isShuffle = !isShuffle;
        sessionStorage.setItem('musi_shuffle', isShuffle);
        document.getElementById('shuffle-btn').classList.toggle('active');
    }

    setInterval(() => {
        if(player && player.getCurrentTime) sessionStorage.setItem('musi_time', player.getCurrentTime());
    }, 1000);

    // LÃ³gica do Quebra-CabeÃ§a
    const puzzle = document.getElementById("puzzle");
    const piecesSelect = document.getElementById("pieces-select");
    const imageSelect = document.getElementById("image-select");
    const startBtn = document.getElementById("start-btn");
    const instructions = document.getElementById("instructions");
    const puzzleContainer = document.getElementById("puzzle-container");

    let rows, cols, totalPieces, imageUrl, draggedPiece = null;

    startBtn.onclick = () => {
        totalPieces = Number(piecesSelect.value);
        if(totalPieces === 4){ rows = 2; cols = 2; }
        else if(totalPieces === 6){ rows = 2; cols = 3; }
        else if(totalPieces === 9){ rows = 3; cols = 3; }
        else { rows = 3; cols = 5; }
        
        imageUrl = imageSelect.value;
        puzzleContainer.style.display = 'block';
        instructions.textContent = "Arraste as peÃ§as para montar!";
        createPuzzle();
        window.scrollTo({ top: puzzleContainer.offsetTop - 20, behavior: 'smooth' });
    };

    function createPuzzle() {
        puzzle.innerHTML = "";
        puzzle.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        puzzle.style.aspectRatio = `${cols} / ${rows}`;
        let piecesArr = [];
        for(let i=0; i<totalPieces; i++) {
            const piece = document.createElement("div");
            piece.classList.add("piece");
            piece.style.backgroundImage = `url(${imageUrl})`;
            piece.style.backgroundSize = `${cols*100}% ${rows*100}%`;
            const r = Math.floor(i / cols);
            const c = i % cols;
            piece.style.backgroundPosition = `${(c*100)/(cols-1)}% ${(r*100)/(rows-1)}%`;
            piece.draggable = true;
            piece.dataset.index = i;
            
            // Eventos Mouse
            piece.addEventListener('dragstart', () => draggedPiece = piece);
            piece.addEventListener('dragover', e => e.preventDefault());
            piece.addEventListener('drop', () => swapPieces(piece));
            
            // Suporte Touch BÃ¡sico
            piece.addEventListener('touchstart', (e) => { draggedPiece = piece; }, {passive: true});
            piece.addEventListener('touchend', (e) => {
                let touch = e.changedTouches[0];
                let target = document.elementFromPoint(touch.clientX, touch.clientY);
                if (target && target.classList.contains('piece') && target !== piece) swapPieces(target);
            });

            piecesArr.push(piece);
        }
        // Embaralhar
        piecesArr.sort(() => Math.random() - 0.5);
        piecesArr.forEach(p => puzzle.appendChild(p));
    }

    function swapPieces(targetPiece) {
        const allPieces = Array.from(puzzle.children);
        const srcIdx = allPieces.indexOf(draggedPiece);
        const destIdx = allPieces.indexOf(targetPiece);
        
        if (srcIdx < destIdx) puzzle.insertBefore(draggedPiece, targetPiece.nextSibling);
        else puzzle.insertBefore(draggedPiece, targetPiece);
        
        checkWin();
    }

    function checkWin() {
        const currentOrder = Array.from(puzzle.children).map(p => p.dataset.index);
        if(currentOrder.every((val, i) => Number(val) === i)) {
            instructions.innerHTML = "ğŸŒŸ <strong>ParabÃ©ns! Conseguiste!</strong> ğŸŒŸ";
        }
    }
</script>
</body>
</html>
